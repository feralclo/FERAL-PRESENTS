<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AGENCY FERAL — Contract Management</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --black: #000000;
      --white: #ffffff;
      --red: #ff0033;
      --red-dark: #cc0029;
      --surface: #0a0a0a;
      --surface-2: #111111;
      --border: #1a1a1a;
      --border-light: #222222;
      --text: #ffffff;
      --text-muted: #888888;
      --text-dim: #555555;
      --green: #00cc66;
      --yellow: #ffaa00;
      --font-mono: 'Space Mono', monospace;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    html { -webkit-font-smoothing: antialiased; }

    body {
      background: var(--black);
      color: var(--text);
      font-family: var(--font-sans);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* Noise overlay */
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0.03;
      pointer-events: none;
      z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      background-size: 200px;
    }

    /* Scanlines */
    body::after {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.006) 2px, rgba(255,255,255,0.006) 4px);
      pointer-events: none;
      z-index: 0;
    }

    .app { position: relative; z-index: 1; min-height: 100vh; }

    /* ====== VIEWS ====== */
    .view { display: none; }
    .view.active { display: block; }

    /* ====== LOGIN ====== */
    .login-view {
      display: none;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .login-view.active { display: flex; }

    .login-box {
      width: 100%;
      max-width: 380px;
      text-align: center;
    }

    .login-logo { height: 48px; margin-bottom: 40px; }

    .login-title {
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 32px;
    }

    .login-field {
      width: 100%;
      padding: 14px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.2s;
    }

    .login-field:focus { border-color: var(--red); }
    .login-field::placeholder { color: var(--text-dim); }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--red);
      color: var(--white);
      border: none;
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      cursor: pointer;
      margin-top: 8px;
      transition: background 0.2s;
    }

    .login-btn:hover { background: var(--red-dark); }

    .login-error {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--red);
      margin-top: 16px;
      display: none;
    }

    /* ====== TOP BAR ====== */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar__left { display: flex; align-items: center; gap: 16px; }
    .topbar__logo { height: 32px; }

    .topbar__sep {
      width: 1px;
      height: 20px;
      background: var(--border-light);
    }

    .topbar__label {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .topbar__right { display: flex; align-items: center; gap: 16px; }

    .topbar__user {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .topbar__logout {
      background: none;
      border: 1px solid var(--border-light);
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 6px 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .topbar__logout:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .topbar__settings {
      background: none;
      border: 1px solid var(--border-light);
      color: var(--text-muted);
      padding: 6px 10px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .topbar__settings:hover {
      border-color: var(--red);
      color: var(--red);
    }

    .topbar__settings svg {
      width: 14px;
      height: 14px;
    }

    /* ====== DASHBOARD ====== */
    .dash {
      max-width: 1100px;
      margin: 0 auto;
      padding: 40px 32px;
    }

    @media (max-width: 600px) { .dash { padding: 24px 16px; } }

    .dash__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 40px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .dash__title {
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 4px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-weight: 700;
      padding: 12px 24px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn--red { background: var(--red); color: var(--white); }
    .btn--red:hover { background: var(--red-dark); }
    .btn--dark { background: var(--surface-2); color: var(--white); border: 1px solid var(--border-light); }
    .btn--dark:hover { border-color: var(--text-muted); }
    .btn--outline { background: none; border: 1px solid var(--border-light); color: var(--text-muted); }
    .btn--outline:hover { border-color: var(--red); color: var(--red); }
    .btn--small { padding: 8px 16px; font-size: 9px; }
    .btn--green { background: var(--green); color: var(--black); }
    .btn--green:hover { background: #00aa55; }

    /* Roster section */
    .roster {
      margin-bottom: 48px;
    }

    .roster__heading {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .roster__grid {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .roster__card {
      padding: 16px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .roster__card:hover {
      border-color: var(--red);
    }

    .roster__card.selected {
      border-color: var(--red);
      background: rgba(255, 0, 51, 0.06);
    }

    .roster__dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--red);
      flex-shrink: 0;
    }

    .roster__name {
      font-family: var(--font-mono);
      font-size: 13px;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-weight: 700;
    }

    /* Contracts table */
    .contracts-section { margin-bottom: 40px; }

    .contracts-section__heading {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .contracts-section__count {
      background: var(--surface-2);
      border: 1px solid var(--border);
      padding: 2px 8px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .contract-table {
      width: 100%;
      border-collapse: collapse;
    }

    .contract-table th {
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      text-align: left;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-light);
    }

    .contract-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      vertical-align: middle;
    }

    .contract-table tr:hover td {
      background: var(--surface);
    }

    .contract-table .mono {
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      padding: 4px 10px;
      border: 1px solid;
    }

    .status-badge--draft { color: var(--text-muted); border-color: var(--border-light); }
    .status-badge--sent { color: var(--yellow); border-color: rgba(255, 170, 0, 0.3); }
    .status-badge--signed { color: var(--green); border-color: rgba(0, 204, 102, 0.3); }

    .status-badge__dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: currentColor;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      border: 1px dashed var(--border-light);
    }

    .empty-state__text {
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 20px;
    }

    .actions-cell {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .contract-table, .contract-table thead, .contract-table tbody,
      .contract-table th, .contract-table td, .contract-table tr {
        display: block;
      }
      .contract-table thead { display: none; }
      .contract-table tr {
        margin-bottom: 12px;
        border: 1px solid var(--border);
        padding: 12px;
      }
      .contract-table td {
        padding: 6px 0;
        border: none;
        font-size: 12px;
      }
      .contract-table td::before {
        content: attr(data-label);
        font-family: var(--font-mono);
        font-size: 9px;
        letter-spacing: 1px;
        text-transform: uppercase;
        color: var(--text-dim);
        display: block;
        margin-bottom: 2px;
      }
    }

    /* ====== CREATE CONTRACT VIEW ====== */
    .create-view { display: none; }
    .create-view.active { display: block; }

    .create-form {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 32px;
    }

    @media (max-width: 600px) { .create-form { padding: 24px 16px; } }

    .create-form__back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-muted);
      cursor: pointer;
      background: none;
      border: none;
      margin-bottom: 32px;
      transition: color 0.2s;
    }

    .create-form__back:hover { color: var(--white); }

    .create-form__title {
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 4px;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .create-form__artist {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--red);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
    }

    .form-input:focus { border-color: var(--red); }
    .form-input::placeholder { color: var(--text-dim); }

    .fee-input-group {
      display: flex;
      align-items: stretch;
    }
    .fee-currency-label {
      padding: 12px 14px;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-right: none;
      color: var(--red);
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      min-width: 38px;
      justify-content: center;
    }
    .fee-input-group .form-input { border-left: none; }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath d='M8 12L2 6h12z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 36px;
    }
    .form-select:focus { border-color: var(--red); }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 500px) { .form-row { grid-template-columns: 1fr; } }

    .form-actions {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    /* Signature pad in create form */
    .form-sig {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
    }

    .form-sig__canvas-wrap {
      border: 1px solid var(--border);
      position: relative;
      height: 100px;
      margin-bottom: 8px;
      background: var(--surface);
      cursor: crosshair;
    }

    .form-sig__canvas-wrap canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .form-sig__clear {
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-muted);
      background: none;
      border: 1px solid var(--border);
      padding: 4px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .form-sig__clear:hover {
      color: var(--red);
      border-color: var(--red);
    }

    /* Payment toggles */
    .payment-toggle {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 3px 8px;
      border: 1px solid;
      cursor: pointer;
      transition: all 0.2s;
      background: none;
      white-space: nowrap;
    }

    .payment-toggle--unpaid {
      color: var(--text-dim);
      border-color: var(--border);
    }

    .payment-toggle--unpaid:hover {
      border-color: var(--text-muted);
      color: var(--text-muted);
    }

    .payment-toggle--paid {
      color: var(--green);
      border-color: rgba(0, 204, 102, 0.3);
    }

    .payment-toggle--paid:hover {
      border-color: var(--green);
    }

    .payments-cell {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* Reference number */
    .ref-num {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 1px;
      color: var(--text-dim);
    }

    /* ====== VIEW CONTRACT ====== */
    .view-contract { display: none; }
    .view-contract.active { display: block; }

    /* ====== SEND ANIMATION OVERLAY ====== */
    .send-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: var(--black);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .send-overlay.active { display: flex; }

    .send-overlay__logo {
      height: 60px;
      margin-bottom: 32px;
      opacity: 0;
      animation: send-logo-in 0.6s ease forwards;
    }

    @keyframes send-logo-in {
      0% { opacity: 0; transform: scale(0.8); }
      100% { opacity: 1; transform: scale(1); }
    }

    .send-overlay__text {
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--text-muted);
      opacity: 0;
      animation: send-text-in 0.5s ease 0.4s forwards;
    }

    @keyframes send-text-in {
      0% { opacity: 0; transform: translateY(10px); }
      100% { opacity: 1; transform: translateY(0); }
    }

    .send-overlay__bar {
      width: 200px;
      height: 2px;
      background: var(--border-light);
      margin-top: 24px;
      overflow: hidden;
      opacity: 0;
      animation: send-text-in 0.3s ease 0.6s forwards;
    }

    .send-overlay__progress {
      width: 0%;
      height: 100%;
      background: var(--red);
      animation: send-progress 1.8s ease 0.8s forwards;
    }

    @keyframes send-progress {
      0% { width: 0%; }
      60% { width: 80%; }
      100% { width: 100%; }
    }

    .send-overlay__check {
      opacity: 0;
      margin-top: 24px;
      animation: send-check 0.4s ease 2.8s forwards;
    }

    @keyframes send-check {
      0% { opacity: 0; transform: scale(0.5); }
      50% { transform: scale(1.2); }
      100% { opacity: 1; transform: scale(1); }
    }

    .send-overlay__done {
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--green);
      opacity: 0;
      animation: send-text-in 0.4s ease 3s forwards;
    }

    /* ====== LINK MODAL ====== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 9998;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: var(--surface-2);
      border: 1px solid var(--border-light);
      padding: 40px;
      max-width: 560px;
      width: 90%;
    }

    .modal__title {
      font-family: var(--font-mono);
      font-size: 12px;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .modal__text {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.7;
      margin-bottom: 20px;
    }

    .modal__link-input {
      width: 100%;
      padding: 12px 16px;
      font-family: var(--font-mono);
      font-size: 11px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--white);
      word-break: break-all;
      margin-bottom: 16px;
      outline: none;
    }

    .modal__link-input:focus { border-color: var(--red); }

    .modal__actions { display: flex; gap: 12px; flex-wrap: wrap; }

    .modal__close {
      position: absolute;
      top: 16px; right: 16px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 20px;
      cursor: pointer;
      font-family: var(--font-mono);
    }

    .modal__close:hover { color: var(--white); }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      background: var(--surface-2);
      border: 1px solid var(--border-light);
      color: var(--white);
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 1px;
      padding: 14px 24px;
      z-index: 10000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .toast.visible { transform: translateY(0); opacity: 1; }

    /* ====== DATE PICKER ====== */
    .dp-wrap {
      position: relative;
    }

    .dp-trigger {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      outline: none;
      cursor: pointer;
      transition: border-color 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
      user-select: none;
    }

    .dp-trigger:hover { border-color: var(--border-light); }
    .dp-trigger.active { border-color: var(--red); }

    .dp-trigger__icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
      opacity: 0.4;
    }

    .dp-trigger__text {
      flex: 1;
    }

    .dp-trigger__text:empty::before {
      content: attr(data-placeholder);
      color: var(--text-dim);
    }

    .dp-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      z-index: 5000;
      background: #0a0a0a;
      border: 1px solid var(--border-light);
      padding: 16px;
      min-width: 300px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7);
    }

    .dp-dropdown.open { display: block; }

    .dp-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .dp-nav__title {
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--white);
    }

    .dp-nav__btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 14px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dp-nav__btn:hover {
      border-color: var(--red);
      color: var(--white);
    }

    .dp-weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-bottom: 4px;
    }

    .dp-weekdays span {
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-dim);
      text-align: center;
      padding: 6px 0;
    }

    .dp-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .dp-cell {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--white);
      background: none;
      border: 1px solid transparent;
      padding: 8px 2px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dp-cell:hover {
      border-color: var(--red);
      background: rgba(255, 0, 51, 0.08);
    }

    .dp-cell--empty { pointer-events: none; }

    .dp-cell--today {
      border-color: var(--border-light);
      color: var(--red);
      font-weight: 700;
    }

    .dp-cell--selected {
      background: var(--red);
      color: var(--white);
      font-weight: 700;
      border-color: var(--red);
    }

    .dp-cell--selected:hover {
      background: var(--red-dark);
    }

    .dp-footer {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    .dp-footer__btn {
      flex: 1;
      padding: 7px;
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dp-footer__btn:hover {
      border-color: var(--red);
      color: var(--white);
    }

    .dp-footer__btn--today {
      background: rgba(255, 0, 51, 0.06);
    }

    /* ====== SETTINGS VIEW ====== */
    .settings-content {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 32px;
    }

    @media (max-width: 600px) { .settings-content { padding: 24px 16px; } }

    .settings-section {
      margin-bottom: 40px;
      padding: 24px;
      border: 1px solid var(--border);
      background: var(--surface);
    }

    .settings-section__title {
      font-family: var(--font-mono);
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--red);
    }

    .settings-section__lock {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 16px;
      padding: 10px 14px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .settings-section__lock svg {
      flex-shrink: 0;
    }

    .bank-password-row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }

    .bank-password-row .form-input { flex: 1; }

    .bank-password-row .btn { flex-shrink: 0; }

    /* ====== ARTIST PROFILE VIEW ====== */
    .profile-content {
      max-width: 700px;
      margin: 0 auto;
      padding: 40px 32px;
    }

    @media (max-width: 600px) { .profile-content { padding: 24px 16px; } }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
    }

    .profile-avatar {
      width: 64px;
      height: 64px;
      background: var(--red);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 24px;
      font-weight: 700;
      color: var(--white);
      flex-shrink: 0;
    }

    .profile-name {
      font-family: var(--font-mono);
      font-size: 18px;
      letter-spacing: 4px;
      text-transform: uppercase;
      font-weight: 700;
    }

    .profile-sub {
      font-family: var(--font-mono);
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Print styles */
    @media print {
      body::before, body::after { display: none; }
      .topbar, .actions-bar, .form-actions, .send-overlay, .modal-overlay, .toast { display: none !important; }
      body { background: #fff; color: #000; }
      .contract-print { color: #000; }
    }
  </style>
</head>
<body>

<div class="app" id="app">

  <!-- ====== LOGIN VIEW ====== -->
  <div class="view login-view active" id="loginView">
    <div class="login-box">
      <img src="../images/FERAL%20LOGO.svg" alt="FERAL" class="login-logo">
      <div class="login-title">Agency Portal</div>
      <input type="text" class="login-field" id="loginUser" placeholder="Username" autocomplete="off">
      <input type="password" class="login-field" id="loginPass" placeholder="Password">
      <button class="login-btn" id="loginBtn">Access</button>
      <div class="login-error" id="loginError">Invalid credentials</div>
    </div>
  </div>

  <!-- ====== DASHBOARD VIEW ====== -->
  <div class="view" id="dashView">
    <div class="topbar">
      <div class="topbar__left">
        <img src="../images/FERAL%20LOGO.svg" alt="FERAL" class="topbar__logo">
        <div class="topbar__sep"></div>
        <span class="topbar__label">Agency</span>
      </div>
      <div class="topbar__right">
        <span class="topbar__user" id="topbarUser"></span>
        <button class="topbar__settings" onclick="showSettings()" title="Settings">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
        <button class="topbar__logout" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="dash">
      <div class="dash__header">
        <h1 class="dash__title">Dashboard</h1>
      </div>

      <!-- Roster -->
      <div class="roster">
        <div class="roster__heading">Roster</div>
        <div class="roster__grid" id="rosterGrid"></div>
      </div>

      <!-- Contracts -->
      <div class="contracts-section">
        <div class="contracts-section__heading">
          Contracts <span class="contracts-section__count" id="contractCount">0</span>
        </div>
        <div id="contractsContainer"></div>
      </div>
    </div>
  </div>

  <!-- ====== ARTIST PROFILE VIEW ====== -->
  <div class="view" id="profileView">
    <div class="topbar">
      <div class="topbar__left">
        <img src="../images/FERAL%20LOGO.svg" alt="FERAL" class="topbar__logo">
        <div class="topbar__sep"></div>
        <span class="topbar__label">Artist Profile</span>
      </div>
      <div class="topbar__right">
        <button class="topbar__logout" onclick="showDash()">Back</button>
      </div>
    </div>

    <div class="profile-content">
      <button class="create-form__back" onclick="showDash()">&larr; Back to Dashboard</button>

      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar"></div>
        <div>
          <div class="profile-name" id="profileName"></div>
          <div class="profile-sub">FERAL Roster Artist</div>
        </div>
      </div>

      <div class="settings-section">
        <div class="settings-section__title">Artist Bank Details</div>
        <p style="font-size:12px;color:var(--text-muted);margin-bottom:16px;font-family:var(--font-mono);letter-spacing:1px;">These details will appear on the Artist Fee Invoice.</p>
        <div class="form-group">
          <label class="form-label">Bank Name</label>
          <input type="text" class="form-input" id="artistBankName" placeholder="e.g., Monzo, Barclays">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Sort Code</label>
            <input type="text" class="form-input" id="artistSortCode" placeholder="00-00-00">
          </div>
          <div class="form-group">
            <label class="form-label">Account Number</label>
            <input type="text" class="form-input" id="artistAccNumber" placeholder="00000000">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Account Holder</label>
          <input type="text" class="form-input" id="artistAccHolder" placeholder="Full name on account">
        </div>
        <div style="margin-top:16px;">
          <button class="btn btn--red" onclick="saveArtistProfile()">Save Artist Details</button>
        </div>
      </div>

      <div style="margin-top:24px;">
        <button class="btn btn--red" id="profileCreateBtn">Create Contract</button>
      </div>
    </div>
  </div>

  <!-- ====== SETTINGS VIEW ====== -->
  <div class="view" id="settingsView">
    <div class="topbar">
      <div class="topbar__left">
        <img src="../images/FERAL%20LOGO.svg" alt="FERAL" class="topbar__logo">
        <div class="topbar__sep"></div>
        <span class="topbar__label">Settings</span>
      </div>
      <div class="topbar__right">
        <button class="topbar__logout" onclick="showDash()">Back</button>
      </div>
    </div>

    <div class="settings-content">
      <button class="create-form__back" onclick="showDash()">&larr; Back to Dashboard</button>
      <div class="create-form__title" style="margin-bottom:32px;">Agency Settings</div>

      <!-- Rep Info -->
      <div class="settings-section">
        <div class="settings-section__title">Representative Info</div>
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="setRepName" placeholder="Your full name">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" class="form-input" id="setRepEmail" placeholder="email@agencyferal.com">
        </div>
        <div class="form-group">
          <label class="form-label">Phone</label>
          <input type="text" class="form-input" id="setRepPhone" placeholder="+44 7000 000000">
        </div>
        <div style="margin-top:16px;">
          <button class="btn btn--red" onclick="saveRepInfo()">Save Rep Info</button>
        </div>
      </div>

      <!-- Bank Details -->
      <div class="settings-section">
        <div class="settings-section__title">Agency Bank Details</div>
        <div class="settings-section__lock">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <span>Bank details require a separate password to edit</span>
        </div>
        <div class="bank-password-row" id="bankPassRow">
          <input type="password" class="form-input" id="bankPassInput" placeholder="Enter bank details password">
          <button class="btn btn--red" onclick="unlockBankDetails()">Unlock</button>
        </div>
        <div id="bankFieldsContainer" style="display:none;">
          <div class="form-group">
            <label class="form-label">Bank Name</label>
            <input type="text" class="form-input" id="setBankName" placeholder="e.g., Monzo, Barclays">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Sort Code</label>
              <input type="text" class="form-input" id="setBankSort" placeholder="00-00-00">
            </div>
            <div class="form-group">
              <label class="form-label">Account Number</label>
              <input type="text" class="form-input" id="setBankAcc" placeholder="00000000">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Account Holder</label>
            <input type="text" class="form-input" id="setBankHolder" placeholder="Full name on account">
          </div>
          <div style="margin-top:16px;">
            <button class="btn btn--red" onclick="saveBankDetails()">Save Bank Details</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ====== CREATE CONTRACT VIEW ====== -->
  <div class="view create-view" id="createView">
    <div class="topbar">
      <div class="topbar__left">
        <img src="../images/FERAL%20LOGO.svg" alt="FERAL" class="topbar__logo">
        <div class="topbar__sep"></div>
        <span class="topbar__label">New Contract</span>
      </div>
      <div class="topbar__right">
        <button class="topbar__logout" onclick="showDash()">Cancel</button>
      </div>
    </div>

    <div class="create-form">
      <button class="create-form__back" onclick="showDash()">&larr; Back to Dashboard</button>
      <div class="create-form__title">New Booking Contract</div>
      <div class="create-form__artist" id="createArtistLabel"></div>

      <div class="form-group">
        <label class="form-label">Agreement Date</label>
        <div class="dp-wrap" id="dpAgreementWrap">
          <div class="dp-trigger" id="dpAgreementTrigger">
            <svg class="dp-trigger__icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M3 9h18" stroke="currentColor" stroke-width="1.5"/><path d="M8 2v4M16 2v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            <span class="dp-trigger__text" id="dpAgreementText" data-placeholder="Select agreement date"></span>
          </div>
          <div class="dp-dropdown" id="dpAgreementDrop">
            <div class="dp-nav">
              <button type="button" class="dp-nav__btn" data-dp="agreement" data-dir="prev">&larr;</button>
              <span class="dp-nav__title" id="dpAgreementTitle"></span>
              <button type="button" class="dp-nav__btn" data-dp="agreement" data-dir="next">&rarr;</button>
            </div>
            <div class="dp-weekdays"><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span></div>
            <div class="dp-grid" id="dpAgreementGrid"></div>
            <div class="dp-footer">
              <button type="button" class="dp-footer__btn dp-footer__btn--today" data-dp="agreement" data-action="today">Today</button>
              <button type="button" class="dp-footer__btn" data-dp="agreement" data-action="clear">Clear</button>
            </div>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Promoter / Company</label>
        <input type="text" class="form-input" id="fPromoter" placeholder="Promoter name or company">
      </div>

      <div class="form-group">
        <label class="form-label">Event Name</label>
        <input type="text" class="form-input" id="fEventName" placeholder="Name of event">
      </div>

      <div class="form-group">
        <label class="form-label">Venue</label>
        <input type="text" class="form-input" id="fVenue" placeholder="Venue name & address">
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Event Date</label>
          <div class="dp-wrap" id="dpEventWrap">
            <div class="dp-trigger" id="dpEventTrigger">
              <svg class="dp-trigger__icon" viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M3 9h18" stroke="currentColor" stroke-width="1.5"/><path d="M8 2v4M16 2v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
              <span class="dp-trigger__text" id="dpEventText" data-placeholder="Select event date"></span>
            </div>
            <div class="dp-dropdown" id="dpEventDrop">
              <div class="dp-nav">
                <button type="button" class="dp-nav__btn" data-dp="event" data-dir="prev">&larr;</button>
                <span class="dp-nav__title" id="dpEventTitle"></span>
                <button type="button" class="dp-nav__btn" data-dp="event" data-dir="next">&rarr;</button>
              </div>
              <div class="dp-weekdays"><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span><span>Su</span></div>
              <div class="dp-grid" id="dpEventGrid"></div>
              <div class="dp-footer">
                <button type="button" class="dp-footer__btn dp-footer__btn--today" data-dp="event" data-action="today">Today</button>
                <button type="button" class="dp-footer__btn" data-dp="event" data-action="clear">Clear</button>
              </div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Performance Time</label>
          <input type="text" class="form-input" id="fPerfTime" placeholder="e.g., 01:00 - 02:30">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Currency</label>
          <select class="form-select" id="fCurrency" onchange="updateCurrencyLabels()">
            <option value="GBP">£ GBP — British Pound</option>
            <option value="EUR">€ EUR — Euro</option>
            <option value="USD">$ USD — US Dollar</option>
          </select>
        </div>
        <div class="form-group"></div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Booking Fee</label>
          <div class="fee-input-group">
            <span class="fee-currency-label" id="lblBookingCurrency">£</span>
            <input type="text" class="form-input" id="fBookingFee" placeholder="e.g., 500">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Artist Fee</label>
          <div class="fee-input-group">
            <span class="fee-currency-label" id="lblArtistCurrency">£</span>
            <input type="text" class="form-input" id="fArtistFee" placeholder="e.g., 2,000">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Artist Fee Due Date</label>
          <input type="text" class="form-input" id="fFeeDue" placeholder="30 days before event">
        </div>
        <div class="form-group">
          <label class="form-label">Catering Buy-out</label>
          <div class="fee-input-group">
            <span class="fee-currency-label" id="lblCateringCurrency">£</span>
            <input type="text" class="form-input" id="fCatering" placeholder="e.g., 30">
          </div>
        </div>
      </div>

      <!-- Print Name + Date before Signature -->
      <div class="form-sig">
        <div class="form-group">
          <label class="form-label">Print Name (Agency)</label>
          <input type="text" class="form-input" id="fAgencyPrintName" placeholder="Full name of signatory">
        </div>
        <div class="form-group">
          <label class="form-label">Signing Date</label>
          <input type="text" class="form-input" id="fAgencySignDate" placeholder="Date" readonly style="cursor:default;">
        </div>

        <label class="form-label" style="margin-top:20px;">Your Signature (Agency)</label>
        <div class="form-sig__canvas-wrap">
          <canvas id="createSigCanvas"></canvas>
        </div>
        <button type="button" class="form-sig__clear" id="createSigClear">Clear</button>
      </div>

      <div class="form-actions">
        <button class="btn btn--red" onclick="saveAndSendContract()">Save & Generate Link</button>
        <button class="btn btn--dark" onclick="saveDraft()">Save as Draft</button>
      </div>
    </div>
  </div>

</div>

<!-- Send Animation Overlay -->
<div class="send-overlay" id="sendOverlay">
  <img src="../images/FERAL%20LOGO.svg" alt="FERAL" class="send-overlay__logo">
  <div class="send-overlay__text">Generating contract</div>
  <div class="send-overlay__bar">
    <div class="send-overlay__progress"></div>
  </div>
  <div class="send-overlay__check">
    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
      <circle cx="12" cy="12" r="11" stroke="#00cc66" stroke-width="2"/>
      <path d="M7 12.5l3 3 7-7" stroke="#00cc66" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
  <div class="send-overlay__done">Contract sent</div>
</div>

<!-- Link Modal -->
<div class="modal-overlay" id="linkModal">
  <div class="modal" style="position:relative;">
    <button class="modal__close" onclick="closeLinkModal()">&times;</button>
    <h3 class="modal__title">Promoter Link Ready</h3>
    <p class="modal__text">Send this link to the promoter. They can review the full contract and sign their section.</p>
    <input type="text" class="modal__link-input" id="linkModalUrl" readonly>
    <div class="modal__actions">
      <button class="btn btn--red" onclick="copyPromoterLink()">Copy Link</button>
      <button class="btn btn--dark" onclick="closeLinkModal()">Done</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  // ============================================
  // DATE PICKER
  // ============================================
  function createDatePicker(config) {
    var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    var trigger = document.getElementById(config.triggerId);
    var dropdown = document.getElementById(config.dropdownId);
    var textEl = document.getElementById(config.textId);
    var gridEl = document.getElementById(config.gridId);
    var titleEl = document.getElementById(config.titleId);

    var now = new Date();
    var viewMonth = now.getMonth();
    var viewYear = now.getFullYear();
    var selectedDate = null;

    function ordinal(n) {
      var s = 'th';
      if (n === 1 || n === 21 || n === 31) s = 'st';
      else if (n === 2 || n === 22) s = 'nd';
      else if (n === 3 || n === 23) s = 'rd';
      return n + s;
    }

    function formatDate(d) {
      return ordinal(d.getDate()) + ' ' + MONTHS[d.getMonth()] + ' ' + d.getFullYear();
    }

    function render() {
      titleEl.textContent = MONTHS[viewMonth] + ' ' + viewYear;
      gridEl.innerHTML = '';

      var firstDay = new Date(viewYear, viewMonth, 1).getDay();
      var startOffset = (firstDay + 6) % 7;
      var daysInMonth = new Date(viewYear, viewMonth + 1, 0).getDate();
      var todayStr = now.getFullYear() + '-' + now.getMonth() + '-' + now.getDate();
      var selStr = selectedDate ? selectedDate.getFullYear() + '-' + selectedDate.getMonth() + '-' + selectedDate.getDate() : '';

      for (var e = 0; e < startOffset; e++) {
        var empty = document.createElement('span');
        empty.className = 'dp-cell dp-cell--empty';
        gridEl.appendChild(empty);
      }

      for (var d = 1; d <= daysInMonth; d++) {
        var btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'dp-cell';
        btn.textContent = d;
        var thisStr = viewYear + '-' + viewMonth + '-' + d;
        if (thisStr === todayStr) btn.classList.add('dp-cell--today');
        if (thisStr === selStr) btn.classList.add('dp-cell--selected');
        btn.setAttribute('data-day', d);
        btn.addEventListener('click', function() {
          var day = parseInt(this.getAttribute('data-day'));
          selectedDate = new Date(viewYear, viewMonth, day);
          textEl.textContent = formatDate(selectedDate);
          close();
          render();
        });
        gridEl.appendChild(btn);
      }
    }

    function open() { dropdown.classList.add('open'); trigger.classList.add('active'); }
    function close() { dropdown.classList.remove('open'); trigger.classList.remove('active'); }

    trigger.addEventListener('click', function(e) {
      e.stopPropagation();
      dropdown.classList.contains('open') ? close() : open();
    });

    // Nav buttons
    dropdown.querySelectorAll('.dp-nav__btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (this.getAttribute('data-dir') === 'prev') {
          viewMonth--;
          if (viewMonth < 0) { viewMonth = 11; viewYear--; }
        } else {
          viewMonth++;
          if (viewMonth > 11) { viewMonth = 0; viewYear++; }
        }
        render();
      });
    });

    // Footer buttons
    dropdown.querySelectorAll('.dp-footer__btn').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        var action = this.getAttribute('data-action');
        if (action === 'today') {
          selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          viewMonth = now.getMonth();
          viewYear = now.getFullYear();
          textEl.textContent = formatDate(selectedDate);
          close();
          render();
        } else if (action === 'clear') {
          selectedDate = null;
          textEl.textContent = '';
          close();
          render();
        }
      });
    });

    // Close on outside click
    document.addEventListener('click', function(e) {
      if (!dropdown.contains(e.target) && !trigger.contains(e.target)) close();
    });
    dropdown.addEventListener('click', function(e) { e.stopPropagation(); });

    render();

    return {
      getValue: function() { return textEl.textContent; },
      setValue: function(val) {
        textEl.textContent = val || '';
        if (val) {
          var parsed = new Date(val.replace(/(\d+)(st|nd|rd|th)/, '$1'));
          if (!isNaN(parsed.getTime())) {
            selectedDate = parsed;
            viewMonth = parsed.getMonth();
            viewYear = parsed.getFullYear();
            render();
          }
        } else {
          selectedDate = null;
          render();
        }
      },
      clear: function() {
        selectedDate = null;
        textEl.textContent = '';
        viewMonth = now.getMonth();
        viewYear = now.getFullYear();
        render();
      },
      setToToday: function() {
        selectedDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        viewMonth = now.getMonth();
        viewYear = now.getFullYear();
        textEl.textContent = formatDate(selectedDate);
        render();
      },
      formatNow: function() {
        return formatDate(now);
      }
    };
  }

  // Init both pickers
  var dpAgreement = createDatePicker({
    triggerId: 'dpAgreementTrigger',
    dropdownId: 'dpAgreementDrop',
    textId: 'dpAgreementText',
    gridId: 'dpAgreementGrid',
    titleId: 'dpAgreementTitle'
  });

  var dpEvent = createDatePicker({
    triggerId: 'dpEventTrigger',
    dropdownId: 'dpEventDrop',
    textId: 'dpEventText',
    gridId: 'dpEventGrid',
    titleId: 'dpEventTitle'
  });

  // ============================================
  // CONFIG
  // ============================================
  var CREDS = { user: 'Kaia', pass: 'fuckingferal' };
  var STORAGE_KEY = 'agencyferal_contracts';
  var AUTH_KEY = 'agencyferal_auth';
  var SETTINGS_KEY = 'agencyferal_settings';
  var ARTISTS_KEY = 'agencyferal_artists';
  var BANK_PASS = 'Parker5656!';

  // ============================================
  // SUPABASE CONFIG — Replace these with your Supabase project credentials
  // Go to https://supabase.com → Create Project → Settings → API
  // ============================================
  var SUPABASE_URL = 'https://rqtfghzhkkdytkegcifm.supabase.co';
  var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxdGZnaHpoa2tkeXRrZWdjaWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTUwMTUsImV4cCI6MjA4NTY5MTAxNX0.8IVDc92EYAq4FhTqVy0k5ur79zD9XofBBFjAuctKOUc';
  var supabase = null;
  var dbReady = false;

  if (SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    dbReady = true;
    console.log('[AGENCY FERAL] Supabase connected — data will persist across devices');
  } else {
    console.log('[AGENCY FERAL] Supabase not configured — using local storage only. To enable cloud sync, set SUPABASE_URL and SUPABASE_ANON_KEY.');
  }

  // ============================================
  // DATABASE LAYER — syncs localStorage ↔ Supabase
  // ============================================
  function dbSaveContracts(contracts) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(contracts));
    if (!dbReady) return;
    // Upsert all contracts to Supabase
    contracts.forEach(function(c) {
      supabase.from('contracts').upsert({
        id: c.id,
        ref: c.ref,
        data: c.data,
        status: c.status,
        created: c.created,
        sent: c.sent,
        signed: c.signed,
        booking_fee_received: c.booking_fee_received || false,
        artist_fee_received: c.artist_fee_received || false,
        promoter_link: c.promoter_link,
        promoter_company: c.promoter_company || null,
        promoter_address: c.promoter_address || null,
        promoter_email: c.promoter_email || null,
        promoter_phone: c.promoter_phone || null,
        _sig_promoter: c._sig_promoter || null
      }, { onConflict: 'id' }).then(function(res) {
        if (res.error) console.error('[DB] Contract save error:', res.error);
      });
    });
  }

  function dbDeleteContract(id) {
    if (!dbReady) return;
    supabase.from('contracts').delete().eq('id', id).then(function(res) {
      if (res.error) console.error('[DB] Contract delete error:', res.error);
    });
  }

  function dbSaveSettings(data) {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(data));
    if (!dbReady) return;
    supabase.from('settings').upsert({
      id: 'main',
      data: data
    }, { onConflict: 'id' }).then(function(res) {
      if (res.error) console.error('[DB] Settings save error:', res.error);
    });
  }

  function dbSaveArtists(data) {
    localStorage.setItem(ARTISTS_KEY, JSON.stringify(data));
    if (!dbReady) return;
    supabase.from('artists').upsert({
      id: 'all',
      data: data
    }, { onConflict: 'id' }).then(function(res) {
      if (res.error) console.error('[DB] Artists save error:', res.error);
    });
  }

  // Load data from Supabase into localStorage on login
  async function dbSyncFromCloud() {
    if (!dbReady) return;
    try {
      // Load contracts
      var cRes = await supabase.from('contracts').select('*');
      if (cRes.data && cRes.data.length > 0) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(cRes.data));
        console.log('[DB] Loaded ' + cRes.data.length + ' contracts from cloud');
      }
      // Load settings
      var sRes = await supabase.from('settings').select('*').eq('id', 'main').single();
      if (sRes.data && sRes.data.data) {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(sRes.data.data));
        console.log('[DB] Loaded settings from cloud');
      }
      // Load artists
      var aRes = await supabase.from('artists').select('*').eq('id', 'all').single();
      if (aRes.data && aRes.data.data) {
        localStorage.setItem(ARTISTS_KEY, JSON.stringify(aRes.data.data));
        console.log('[DB] Loaded artists from cloud');
      }
    } catch(e) {
      console.error('[DB] Cloud sync error:', e);
    }
  }

  var ROSTER = [
    { id: 'stevie', name: 'STEVIE' }
  ];

  // ============================================
  // STATE
  // ============================================
  var currentArtist = null;
  var editingContractId = null;
  var bankUnlocked = false;

  // ============================================
  // SIGNATURE PAD (create form)
  // ============================================
  var createSigCanvas = document.getElementById('createSigCanvas');
  var createSigCtx = createSigCanvas.getContext('2d');
  var sigDrawing = false;
  var sigLastX, sigLastY;

  function resizeCreateSig() {
    var wrap = createSigCanvas.parentElement;
    var data = createSigCanvas.toDataURL();
    createSigCanvas.width = wrap.offsetWidth;
    createSigCanvas.height = wrap.offsetHeight;
    if (data && data !== 'data:,') {
      var img = new Image();
      img.onload = function() { createSigCtx.drawImage(img, 0, 0); };
      img.src = data;
    }
    createSigCtx.strokeStyle = '#fff';
    createSigCtx.lineWidth = 2;
    createSigCtx.lineCap = 'round';
    createSigCtx.lineJoin = 'round';
  }

  function getSigPos(e) {
    var rect = createSigCanvas.getBoundingClientRect();
    var touch = e.touches ? e.touches[0] : e;
    return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
  }

  createSigCanvas.addEventListener('mousedown', function(e) { e.preventDefault(); sigDrawing = true; var p = getSigPos(e); sigLastX = p.x; sigLastY = p.y; });
  createSigCanvas.addEventListener('mousemove', function(e) { if (!sigDrawing) return; e.preventDefault(); var p = getSigPos(e); createSigCtx.beginPath(); createSigCtx.moveTo(sigLastX, sigLastY); createSigCtx.lineTo(p.x, p.y); createSigCtx.stroke(); sigLastX = p.x; sigLastY = p.y; });
  createSigCanvas.addEventListener('mouseup', function() { sigDrawing = false; });
  createSigCanvas.addEventListener('mouseleave', function() { sigDrawing = false; });
  createSigCanvas.addEventListener('touchstart', function(e) { e.preventDefault(); sigDrawing = true; var p = getSigPos(e); sigLastX = p.x; sigLastY = p.y; }, { passive: false });
  createSigCanvas.addEventListener('touchmove', function(e) { if (!sigDrawing) return; e.preventDefault(); var p = getSigPos(e); createSigCtx.beginPath(); createSigCtx.moveTo(sigLastX, sigLastY); createSigCtx.lineTo(p.x, p.y); createSigCtx.stroke(); sigLastX = p.x; sigLastY = p.y; }, { passive: false });
  createSigCanvas.addEventListener('touchend', function() { sigDrawing = false; });

  document.getElementById('createSigClear').addEventListener('click', function() {
    createSigCtx.clearRect(0, 0, createSigCanvas.width, createSigCanvas.height);
  });

  // Resize on view change (since canvas may be hidden initially)
  var sigResizeObserver = new MutationObserver(function() {
    if (document.getElementById('createView').classList.contains('active')) {
      setTimeout(resizeCreateSig, 50);
    }
  });
  sigResizeObserver.observe(document.getElementById('createView'), { attributes: true, attributeFilter: ['class'] });
  window.addEventListener('resize', resizeCreateSig);

  function getCreateSigData() {
    return createSigCanvas.toDataURL();
  }

  function clearCreateSig() {
    createSigCtx.clearRect(0, 0, createSigCanvas.width, createSigCanvas.height);
  }

  function restoreCreateSig(dataUrl) {
    if (!dataUrl || dataUrl === 'data:,') return;
    var img = new Image();
    img.onload = function() {
      createSigCtx.clearRect(0, 0, createSigCanvas.width, createSigCanvas.height);
      createSigCtx.drawImage(img, 0, 0);
    };
    img.src = dataUrl;
  }

  // ============================================
  // REFERENCE NUMBER
  // ============================================
  function generateRefNumber() {
    var contracts = getContracts();
    var maxNum = 0;
    contracts.forEach(function(c) {
      if (c.ref) {
        var match = c.ref.match(/AF-(\d+)/);
        if (match) {
          var num = parseInt(match[1]);
          if (num > maxNum) maxNum = num;
        }
      }
    });
    var next = maxNum + 1;
    var padded = ('0000' + next).slice(-4);
    return 'AF-' + padded;
  }

  // ============================================
  // DATE HELPERS
  // ============================================
  function getTodayFormatted() {
    var MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    var now = new Date();
    var d = now.getDate();
    var s = 'th';
    if (d === 1 || d === 21 || d === 31) s = 'st';
    else if (d === 2 || d === 22) s = 'nd';
    else if (d === 3 || d === 23) s = 'rd';
    return d + s + ' ' + MONTHS[now.getMonth()] + ' ' + now.getFullYear();
  }

  // ============================================
  // AUTH
  // ============================================
  function isAuthed() {
    return sessionStorage.getItem(AUTH_KEY) === 'true';
  }

  function login() {
    var u = document.getElementById('loginUser').value.trim();
    var p = document.getElementById('loginPass').value;
    if (u === CREDS.user && p === CREDS.pass) {
      sessionStorage.setItem(AUTH_KEY, 'true');
      document.getElementById('topbarUser').textContent = u;
      showDash();
    } else {
      document.getElementById('loginError').style.display = 'block';
      document.getElementById('loginPass').value = '';
    }
  }

  function logout() {
    sessionStorage.removeItem(AUTH_KEY);
    bankUnlocked = false;
    showView('loginView');
  }

  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('loginPass').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') login();
  });
  document.getElementById('loginUser').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') document.getElementById('loginPass').focus();
  });

  // ============================================
  // VIEWS
  // ============================================
  function showView(id) {
    document.querySelectorAll('.view').forEach(function(v) { v.classList.remove('active'); });
    document.getElementById(id).classList.add('active');
  }

  async function showDash() {
    showView('dashView');
    // Sync from cloud first if available
    await dbSyncFromCloud();
    renderRoster();
    renderContracts();
  }

  function showCreate(artistId) {
    currentArtist = ROSTER.find(function(a) { return a.id === artistId; });
    if (!currentArtist) return;
    editingContractId = null;
    document.getElementById('createArtistLabel').textContent = 'Artist: ' + currentArtist.name;
    // Clear form
    ['fPromoter','fEventName','fVenue','fPerfTime','fBookingFee','fArtistFee','fFeeDue','fCatering','fAgencyPrintName'].forEach(function(id) {
      document.getElementById(id).value = '';
    });
    document.getElementById('fCurrency').value = 'GBP';
    updateCurrencyLabels();
    dpAgreement.clear();
    dpEvent.clear();
    clearCreateSig();

    // Auto-fill agreement date and sign date to today for new contracts
    dpAgreement.setToToday();
    document.getElementById('fAgencySignDate').value = getTodayFormatted();

    showView('createView');
  }

  // ============================================
  // SETTINGS
  // ============================================
  function getSettings() {
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {}; }
    catch(e) { return {}; }
  }

  function saveSettingsData(data) {
    dbSaveSettings(data);
  }

  function showSettings() {
    var s = getSettings();
    document.getElementById('setRepName').value = s.rep_name || '';
    document.getElementById('setRepEmail').value = s.rep_email || '';
    document.getElementById('setRepPhone').value = s.rep_phone || '';

    // Reset bank lock state
    bankUnlocked = false;
    document.getElementById('bankPassRow').style.display = 'flex';
    document.getElementById('bankFieldsContainer').style.display = 'none';
    document.getElementById('bankPassInput').value = '';

    showView('settingsView');
  }

  function saveRepInfo() {
    var s = getSettings();
    s.rep_name = document.getElementById('setRepName').value.trim();
    s.rep_email = document.getElementById('setRepEmail').value.trim();
    s.rep_phone = document.getElementById('setRepPhone').value.trim();
    saveSettingsData(s);
    showToast('Representative info saved');
  }

  function unlockBankDetails() {
    var pass = document.getElementById('bankPassInput').value;
    if (pass === BANK_PASS) {
      bankUnlocked = true;
      document.getElementById('bankPassRow').style.display = 'none';
      document.getElementById('bankFieldsContainer').style.display = 'block';
      // Load existing bank details
      var s = getSettings();
      document.getElementById('setBankName').value = s.bank_name || '';
      document.getElementById('setBankSort').value = s.bank_sort || '';
      document.getElementById('setBankAcc').value = s.bank_acc || '';
      document.getElementById('setBankHolder').value = s.bank_holder || '';
      showToast('Bank details unlocked');
    } else {
      showToast('Incorrect password');
    }
  }

  function saveBankDetails() {
    if (!bankUnlocked) return;
    var s = getSettings();
    s.bank_name = document.getElementById('setBankName').value.trim();
    s.bank_sort = document.getElementById('setBankSort').value.trim();
    s.bank_acc = document.getElementById('setBankAcc').value.trim();
    s.bank_holder = document.getElementById('setBankHolder').value.trim();
    saveSettingsData(s);
    showToast('Bank details saved');
  }

  // ============================================
  // ARTIST PROFILES
  // ============================================
  function getArtists() {
    try { return JSON.parse(localStorage.getItem(ARTISTS_KEY)) || {}; }
    catch(e) { return {}; }
  }

  function saveArtistsData(data) {
    dbSaveArtists(data);
  }

  function showArtistProfile(artistId) {
    currentArtist = ROSTER.find(function(a) { return a.id === artistId; });
    if (!currentArtist) return;

    document.getElementById('profileName').textContent = currentArtist.name;
    document.getElementById('profileAvatar').textContent = currentArtist.name.charAt(0);

    // Load artist data
    var artists = getArtists();
    var a = artists[artistId] || {};
    document.getElementById('artistBankName').value = a.bank_name || '';
    document.getElementById('artistSortCode').value = a.sort_code || '';
    document.getElementById('artistAccNumber').value = a.acc_number || '';
    document.getElementById('artistAccHolder').value = a.acc_holder || '';

    // Set up create contract button
    document.getElementById('profileCreateBtn').onclick = function() {
      showCreate(artistId);
    };

    showView('profileView');
  }

  function saveArtistProfile() {
    if (!currentArtist) return;
    var artists = getArtists();
    artists[currentArtist.id] = {
      bank_name: document.getElementById('artistBankName').value.trim(),
      sort_code: document.getElementById('artistSortCode').value.trim(),
      acc_number: document.getElementById('artistAccNumber').value.trim(),
      acc_holder: document.getElementById('artistAccHolder').value.trim()
    };
    saveArtistsData(artists);
    showToast('Artist details saved');
  }

  // ============================================
  // CURRENCY HELPERS
  // ============================================
  var CURRENCY_SYMBOLS = { GBP: '£', EUR: '€', USD: '$' };

  function getCurrencySymbol(code) {
    return CURRENCY_SYMBOLS[code] || '£';
  }

  function updateCurrencyLabels() {
    var sel = document.getElementById('fCurrency');
    var sym = getCurrencySymbol(sel.value);
    document.getElementById('lblBookingCurrency').textContent = sym;
    document.getElementById('lblArtistCurrency').textContent = sym;
    document.getElementById('lblCateringCurrency').textContent = sym;
  }

  function formatFee(amount, currencyCode) {
    if (!amount || amount === 'N/A') return 'N/A';
    var sym = getCurrencySymbol(currencyCode || 'GBP');
    var num = amount.toString().replace(/[^0-9.,]/g, '');
    return sym + num;
  }

  // ============================================
  // CONTRACTS STORAGE
  // ============================================
  function getContracts() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
    catch(e) { return []; }
  }

  function saveContracts(contracts) {
    dbSaveContracts(contracts);
  }

  function generateId() {
    return 'c_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
  }

  function collectFormData() {
    return {
      agreement_date: dpAgreement.getValue(),
      promoter_name: document.getElementById('fPromoter').value,
      artist_name: currentArtist ? currentArtist.name : '',
      artist_id: currentArtist ? currentArtist.id : '',
      event_name: document.getElementById('fEventName').value,
      venue: document.getElementById('fVenue').value,
      event_date: dpEvent.getValue(),
      performance_time: document.getElementById('fPerfTime').value,
      currency: document.getElementById('fCurrency').value,
      booking_fee: document.getElementById('fBookingFee').value,
      artist_fee: document.getElementById('fArtistFee').value,
      fee_due_date: document.getElementById('fFeeDue').value,
      catering_buyout: document.getElementById('fCatering').value,
      agency_print_name: document.getElementById('fAgencyPrintName').value,
      agency_sign_date: document.getElementById('fAgencySignDate').value,
      _sig_agency: getCreateSigData()
    };
  }

  function saveDraft() {
    var data = collectFormData();
    var contracts = getContracts();
    var existingContract = editingContractId ? contracts.find(function(c) { return c.id === editingContractId; }) : null;
    var contract = {
      id: editingContractId || generateId(),
      ref: existingContract ? existingContract.ref : generateRefNumber(),
      data: data,
      status: 'draft',
      created: existingContract ? existingContract.created : new Date().toISOString(),
      sent: null,
      signed: false,
      booking_fee_received: existingContract ? (existingContract.booking_fee_received || false) : false,
      artist_fee_received: existingContract ? (existingContract.artist_fee_received || false) : false,
      promoter_link: null
    };
    var idx = contracts.findIndex(function(c) { return c.id === contract.id; });
    if (idx >= 0) { contracts[idx] = contract; }
    else { contracts.unshift(contract); }
    saveContracts(contracts);
    showToast('Draft saved');
    showDash();
  }

  function saveAndSendContract() {
    var data = collectFormData();
    if (!data.promoter_name || !data.event_name) {
      showToast('Please fill in at least Promoter and Event Name');
      return;
    }

    var contracts = getContracts();
    var contractId = editingContractId || generateId();
    var existingContract = editingContractId ? contracts.find(function(c) { return c.id === editingContractId; }) : null;
    var ref = existingContract ? existingContract.ref : generateRefNumber();

    var encodedData = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
    var base = window.location.origin;
    var promoterLink = base + '/contract/stevie/?sign=' + contractId + '&d=' + encodedData;

    var contract = {
      id: contractId,
      ref: ref,
      data: data,
      status: 'sent',
      created: existingContract ? existingContract.created : new Date().toISOString(),
      sent: new Date().toISOString(),
      signed: false,
      booking_fee_received: existingContract ? (existingContract.booking_fee_received || false) : false,
      artist_fee_received: existingContract ? (existingContract.artist_fee_received || false) : false,
      promoter_link: promoterLink
    };

    var idx = contracts.findIndex(function(c) { return c.id === contract.id; });
    if (idx >= 0) { contracts[idx] = contract; }
    else { contracts.unshift(contract); }
    saveContracts(contracts);

    showSendAnimation(function() {
      document.getElementById('linkModalUrl').value = promoterLink;
      document.getElementById('linkModal').classList.add('active');
    });
  }

  // ============================================
  // PAYMENT TRACKING
  // ============================================
  function togglePayment(contractId, field) {
    var contracts = getContracts();
    var c = contracts.find(function(x) { return x.id === contractId; });
    if (!c) return;
    c[field] = !c[field];
    saveContracts(contracts);
    renderContracts();
    showToast(field === 'booking_fee_received' ? 'Booking fee updated' : 'Artist fee updated');
  }

  // ============================================
  // INVOICE GENERATION
  // ============================================
  function generateInvoiceHTML(type, contract) {
    var settings = getSettings();
    var artists = getArtists();
    var artistData = artists[contract.data.artist_id] || {};
    var d = contract.data;
    var today = getTodayFormatted();
    var isBooking = (type === 'booking');

    var title = isBooking ? 'BOOKING FEE INVOICE' : 'ARTIST FEE INVOICE';
    var rawAmount = isBooking ? (d.booking_fee || 'N/A') : (d.artist_fee || 'N/A');
    var amount = formatFee(rawAmount, d.currency);
    var paymentTerms = isBooking ? 'Due on receipt' : ('Due ' + (d.fee_due_date || 'as per contract'));

    // Determine bank details
    var bankName, bankSort, bankAcc, bankHolder;
    if (isBooking) {
      bankName = settings.bank_name || '';
      bankSort = settings.bank_sort || '';
      bankAcc = settings.bank_acc || '';
      bankHolder = settings.bank_holder || '';
    } else {
      bankName = artistData.bank_name || '';
      bankSort = artistData.sort_code || '';
      bankAcc = artistData.acc_number || '';
      bankHolder = artistData.acc_holder || '';
    }

    var warningHTML = '';
    if (isBooking) {
      warningHTML = '<div style="background:#ff0033;color:#fff;padding:20px 24px;margin:32px 0;font-family:\'Space Mono\',monospace;font-size:12px;letter-spacing:1px;line-height:1.8;font-weight:700;text-align:center;">THIS INVOICE MUST BE PAID IMMEDIATELY TO SECURE THE ARTIST.<br>PROMOTION OF THIS EVENT IS NOT PERMITTED UNTIL PAYMENT IS RECEIVED.</div>';
    } else {
      warningHTML = '<div style="border:3px solid #ff0033;background:rgba(255,0,51,0.1);color:#ff0033;padding:20px 24px;margin:32px 0;font-family:\'Space Mono\',monospace;font-size:12px;letter-spacing:1px;line-height:1.8;font-weight:700;text-align:center;">IMPORTANT: DO NOT PAY THE ARTIST FEE INTO THE BOOKING FEE ACCOUNT.<br>PLEASE USE THE ARTIST BANK DETAILS BELOW.</div>';
    }

    var html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">';
    html += '<title>' + title + ' - ' + (contract.ref || '') + '</title>';
    html += '<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">';
    html += '<style>';
    html += '*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }';
    html += 'html { background: #000 !important; }';
    html += 'body { background: #000; color: #fff; font-family: "Inter", sans-serif; line-height: 1.6; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }';
    html += '* { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }';
    html += '@media print { html, body { background: #000 !important; color: #fff !important; } .no-print { display: none !important; } @page { margin: 0.5cm; } }';
    html += '</style></head><body>';
    html += '<div style="max-width:700px;margin:0 auto;padding:48px 40px;">';

    // Print/Download buttons
    html += '<div class="no-print" style="display:flex;gap:12px;margin-bottom:32px;">';
    html += '<button onclick="window.print()" style="padding:12px 24px;background:#ff0033;color:#fff;border:none;font-family:\'Space Mono\',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;font-weight:700;cursor:pointer;">Print / Download PDF</button>';
    html += '<button onclick="window.close()" style="padding:12px 24px;background:#111;color:#fff;border:1px solid #222;font-family:\'Space Mono\',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;">Close</button>';
    html += '</div>';

    // Logo
    html += '<div style="text-align:center;padding-bottom:32px;border-bottom:2px solid #fff;">';
    html += '<img src="../images/FERAL%20LOGO.svg" alt="FERAL" style="height:48px;margin-bottom:24px;">';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:14px;letter-spacing:6px;text-transform:uppercase;font-weight:700;">' + title + '</div>';
    html += '<div style="width:40px;height:2px;background:#ff0033;margin:16px auto 0;"></div>';
    html += '</div>';

    // Invoice meta
    html += '<div style="display:flex;justify-content:space-between;margin-top:32px;padding:20px 24px;border:1px solid #222;background:#0a0a0a;">';
    html += '<div><span style="font-family:\'Space Mono\',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#888;display:block;">Reference</span><span style="font-family:\'Space Mono\',monospace;font-size:13px;">' + (contract.ref || 'N/A') + '</span></div>';
    html += '<div style="text-align:right;"><span style="font-family:\'Space Mono\',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#888;display:block;">Invoice Date</span><span style="font-family:\'Space Mono\',monospace;font-size:13px;">' + today + '</span></div>';
    html += '</div>';

    // From / To
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:32px;margin-top:24px;">';
    html += '<div style="padding:20px 24px;border:1px solid #222;border-left:3px solid #ff0033;background:#0a0a0a;">';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#ff0033;margin-bottom:12px;">From</div>';
    html += '<div style="font-weight:700;margin-bottom:4px;">AGENCY FERAL</div>';
    if (settings.rep_name) html += '<div style="font-size:13px;color:#ccc;">' + settings.rep_name + '</div>';
    if (settings.rep_email) html += '<div style="font-size:13px;color:#888;">' + settings.rep_email + '</div>';
    if (settings.rep_phone) html += '<div style="font-size:13px;color:#888;">' + settings.rep_phone + '</div>';
    html += '</div>';

    html += '<div style="padding:20px 24px;border:1px solid #222;border-left:3px solid #fff;background:#0a0a0a;">';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:12px;">To</div>';
    html += '<div style="font-weight:700;margin-bottom:4px;">' + (contract.promoter_company || d.promoter_name || 'N/A') + '</div>';
    if (contract.promoter_address) html += '<div style="font-size:13px;color:#ccc;">' + contract.promoter_address + '</div>';
    if (contract.promoter_email) html += '<div style="font-size:13px;color:#888;">' + contract.promoter_email + '</div>';
    if (contract.promoter_phone) html += '<div style="font-size:13px;color:#888;">' + contract.promoter_phone + '</div>';
    html += '</div>';
    html += '</div>';

    // Event details
    html += '<div style="margin-top:24px;">';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:#888;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #222;">Event Details</div>';
    html += '<table style="width:100%;border-collapse:collapse;">';
    html += '<tr><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;width:160px;">Event Name</td><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-size:14px;">' + (d.event_name || 'N/A') + '</td></tr>';
    html += '<tr><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;">Event Date</td><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-size:14px;">' + (d.event_date || 'N/A') + '</td></tr>';
    html += '<tr><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;">Artist</td><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-size:14px;">' + (d.artist_name || 'N/A') + '</td></tr>';
    html += '<tr><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;">Venue</td><td style="padding:10px 16px;border-bottom:1px solid #1a1a1a;font-size:14px;">' + (d.venue || 'N/A') + '</td></tr>';
    html += '</table>';
    html += '</div>';

    // Amount
    html += '<div style="margin-top:24px;padding:24px;border:2px solid #ff0033;background:rgba(255,0,51,0.05);text-align:center;">';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#888;margin-bottom:8px;">' + (isBooking ? 'Booking Fee' : 'Artist Fee') + '</div>';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:28px;font-weight:700;color:#fff;">' + amount + '</div>';
    html += '</div>';

    // Warning
    html += warningHTML;

    // Bank details
    html += '<div style="margin-top:24px;padding:20px 24px;border:1px solid #222;background:#0a0a0a;">';
    html += '<div style="font-family:\'Space Mono\',monospace;font-size:10px;letter-spacing:3px;text-transform:uppercase;color:#ff0033;margin-bottom:16px;">' + (isBooking ? 'Agency Bank Details' : 'Artist Bank Details') + '</div>';
    html += '<table style="width:100%;border-collapse:collapse;">';
    html += '<tr><td style="padding:8px 0;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;width:160px;">Bank Name</td><td style="padding:8px 0;font-size:14px;">' + (bankName || 'N/A') + '</td></tr>';
    html += '<tr><td style="padding:8px 0;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;">Sort Code</td><td style="padding:8px 0;font-size:14px;">' + (bankSort || 'N/A') + '</td></tr>';
    html += '<tr><td style="padding:8px 0;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;">Account Number</td><td style="padding:8px 0;font-size:14px;">' + (bankAcc || 'N/A') + '</td></tr>';
    html += '<tr><td style="padding:8px 0;font-family:\'Space Mono\',monospace;font-size:11px;color:#888;">Account Holder</td><td style="padding:8px 0;font-size:14px;">' + (bankHolder || 'N/A') + '</td></tr>';
    html += '</table>';
    html += '</div>';

    // Payment terms
    html += '<div style="margin-top:24px;padding:16px 24px;border:1px solid #222;font-family:\'Space Mono\',monospace;font-size:11px;letter-spacing:1px;color:#888;">';
    html += 'Payment Terms: <span style="color:#fff;">' + paymentTerms + '</span>';
    html += '</div>';

    // Footer
    html += '<div style="margin-top:48px;padding-top:16px;border-top:1px solid #222;text-align:center;font-family:\'Space Mono\',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#555;">';
    html += '&copy; 2026 FERAL PRESENTS. All rights reserved. &mdash; Confidential Document';
    html += '</div>';

    html += '</div></body></html>';
    return html;
  }

  function openInvoice(type, contractId) {
    var contracts = getContracts();
    var c = contracts.find(function(x) { return x.id === contractId; });
    if (!c) { showToast('Contract not found'); return; }
    var html = generateInvoiceHTML(type, c);
    var w = window.open('', '_blank');
    w.document.write(html);
    w.document.close();
  }

  // ============================================
  // RENDER
  // ============================================
  function renderRoster() {
    var grid = document.getElementById('rosterGrid');
    grid.innerHTML = '';
    ROSTER.forEach(function(artist) {
      var card = document.createElement('div');
      card.className = 'roster__card';
      card.innerHTML = '<span class="roster__dot"></span><span class="roster__name">' + artist.name + '</span>';
      card.addEventListener('click', function() { showArtistProfile(artist.id); });
      grid.appendChild(card);
    });
  }

  function renderContracts() {
    var contracts = getContracts();
    var container = document.getElementById('contractsContainer');
    document.getElementById('contractCount').textContent = contracts.length;

    if (contracts.length === 0) {
      container.innerHTML = '<div class="empty-state"><div class="empty-state__text">No contracts yet</div><button class="btn btn--outline btn--small" onclick="showCreate(\'stevie\')">Create First Contract</button></div>';
      return;
    }

    var html = '<table class="contract-table"><thead><tr>';
    html += '<th>Ref</th><th>Artist</th><th>Promoter / Event</th><th>Date</th><th>Status</th><th>Payments</th><th>Actions</th>';
    html += '</tr></thead><tbody>';

    contracts.forEach(function(c) {
      var statusClass = 'draft';
      var statusLabel = 'Draft';
      if (c.signed) { statusClass = 'signed'; statusLabel = 'Signed'; }
      else if (c.status === 'sent') { statusClass = 'sent'; statusLabel = 'Sent'; }

      var bfPaid = c.booking_fee_received;
      var afPaid = c.artist_fee_received;

      html += '<tr>';
      html += '<td data-label="Ref"><span class="ref-num">' + (c.ref || '—') + '</span></td>';
      html += '<td data-label="Artist" class="mono">' + (c.data.artist_name || '—') + '</td>';
      html += '<td data-label="Event"><strong>' + (c.data.promoter_name || '—') + '</strong><br><span style="color:var(--text-muted);font-size:12px;">' + (c.data.event_name || '') + '</span></td>';
      html += '<td data-label="Date" class="mono" style="font-size:11px;color:var(--text-muted);">' + (c.data.event_date || '—') + '</td>';
      html += '<td data-label="Status"><span class="status-badge status-badge--' + statusClass + '"><span class="status-badge__dot"></span>' + statusLabel + '</span></td>';

      // Payments column
      html += '<td data-label="Payments"><div class="payments-cell">';
      var bfDisplay = c.data.booking_fee ? formatFee(c.data.booking_fee, c.data.currency) : 'Booking Fee';
      var afDisplay = c.data.artist_fee ? formatFee(c.data.artist_fee, c.data.currency) : 'Artist Fee';
      html += '<button class="payment-toggle payment-toggle--' + (bfPaid ? 'paid' : 'unpaid') + '" onclick="togglePayment(\'' + c.id + '\',\'booking_fee_received\')">';
      html += (bfPaid ? '&#10003; ' : '') + bfDisplay + '</button>';
      html += '<button class="payment-toggle payment-toggle--' + (afPaid ? 'paid' : 'unpaid') + '" onclick="togglePayment(\'' + c.id + '\',\'artist_fee_received\')">';
      html += (afPaid ? '&#10003; ' : '') + afDisplay + '</button>';
      html += '</div></td>';

      html += '<td data-label="Actions"><div class="actions-cell">';
      if (c.promoter_link) {
        html += '<button class="btn btn--outline btn--small" onclick="copyContractLink(\'' + c.id + '\')">Copy Link</button>';
      }
      if (c.status === 'draft') {
        html += '<button class="btn btn--outline btn--small" onclick="editContract(\'' + c.id + '\')">Edit</button>';
      }
      html += '<button class="btn btn--outline btn--small" onclick="viewContractPage(\'' + c.id + '\')">View</button>';
      // Invoice buttons for signed contracts
      if (c.signed) {
        html += '<button class="btn btn--outline btn--small" style="color:var(--green);border-color:rgba(0,204,102,0.3);" onclick="openInvoice(\'booking\',\'' + c.id + '\')">Booking Invoice</button>';
        html += '<button class="btn btn--outline btn--small" style="color:var(--green);border-color:rgba(0,204,102,0.3);" onclick="openInvoice(\'artist\',\'' + c.id + '\')">Artist Invoice</button>';
      }
      html += '<button class="btn btn--outline btn--small" onclick="deleteContract(\'' + c.id + '\')" style="color:var(--red);border-color:rgba(255,0,51,0.3);">Delete</button>';
      html += '</div></td>';
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }

  function editContract(id) {
    var contracts = getContracts();
    var c = contracts.find(function(x) { return x.id === id; });
    if (!c) return;

    currentArtist = ROSTER.find(function(a) { return a.id === c.data.artist_id; }) || ROSTER[0];
    editingContractId = c.id;
    document.getElementById('createArtistLabel').textContent = 'Artist: ' + currentArtist.name;
    dpAgreement.setValue(c.data.agreement_date || '');
    document.getElementById('fPromoter').value = c.data.promoter_name || '';
    document.getElementById('fEventName').value = c.data.event_name || '';
    document.getElementById('fVenue').value = c.data.venue || '';
    dpEvent.setValue(c.data.event_date || '');
    document.getElementById('fPerfTime').value = c.data.performance_time || '';
    document.getElementById('fCurrency').value = c.data.currency || 'GBP';
    updateCurrencyLabels();
    document.getElementById('fBookingFee').value = c.data.booking_fee || '';
    document.getElementById('fArtistFee').value = c.data.artist_fee || '';
    document.getElementById('fFeeDue').value = c.data.fee_due_date || '';
    document.getElementById('fCatering').value = c.data.catering_buyout || '';
    document.getElementById('fAgencyPrintName').value = c.data.agency_print_name || '';
    document.getElementById('fAgencySignDate').value = c.data.agency_sign_date || '';
    showView('createView');
    // Restore signature after view is visible
    setTimeout(function() {
      resizeCreateSig();
      restoreCreateSig(c.data._sig_agency || '');
    }, 100);
  }

  function deleteContract(id) {
    if (!confirm('Delete this contract?')) return;
    dbDeleteContract(id);
    var contracts = getContracts().filter(function(c) { return c.id !== id; });
    saveContracts(contracts);
    renderContracts();
    showToast('Contract deleted');
  }

  function viewContractPage(id) {
    var contracts = getContracts();
    var c = contracts.find(function(x) { return x.id === id; });
    if (!c) return;
    var encodedData = btoa(unescape(encodeURIComponent(JSON.stringify(c.data))));
    var url = window.location.origin + '/contract/stevie/?view=' + c.id + '&d=' + encodedData;
    window.open(url, '_blank');
  }

  function copyContractLink(id) {
    var contracts = getContracts();
    var c = contracts.find(function(x) { return x.id === id; });
    if (!c || !c.promoter_link) return;
    copyToClipboard(c.promoter_link);
    showToast('Promoter link copied');
  }

  function copyPromoterLink() {
    var input = document.getElementById('linkModalUrl');
    copyToClipboard(input.value);
    showToast('Link copied to clipboard');
  }

  function copyToClipboard(text) {
    if (navigator.clipboard) {
      navigator.clipboard.writeText(text);
    } else {
      var ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
  }

  function closeLinkModal() {
    document.getElementById('linkModal').classList.remove('active');
    showDash();
  }

  // ============================================
  // SEND ANIMATION
  // ============================================
  function showSendAnimation(callback) {
    var overlay = document.getElementById('sendOverlay');
    var parent = overlay.parentNode;
    var clone = overlay.cloneNode(true);
    parent.replaceChild(clone, overlay);
    clone.classList.add('active');

    setTimeout(function() {
      clone.classList.remove('active');
      if (callback) callback();
    }, 3800);
  }

  // ============================================
  // TOAST
  // ============================================
  function showToast(msg) {
    var toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('visible');
    setTimeout(function() { toast.classList.remove('visible'); }, 2500);
  }

  // ============================================
  // INIT
  // ============================================
  (function() {
    if (isAuthed()) {
      document.getElementById('topbarUser').textContent = CREDS.user;
      showDash();
    }
  })();
</script>

</body>
</html>
