<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Checkout — FERAL Liverpool | 27 March 2026</title>
  <meta name="robots" content="noindex, nofollow">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      background: #0e0e0e;
      color: #fff;
      min-height: 100vh;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
    }

    /* ========================================
       LOADING INTERSTITIAL
       ======================================== */
    .loading-screen {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: #0e0e0e;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: opacity 0.5s ease;
    }

    .loading-screen--hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-screen__logo {
      width: 140px;
      height: auto;
      margin-bottom: 48px;
      opacity: 0.9;
    }

    .loading-screen__status {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 24px;
    }

    .loading-screen__bar {
      width: 200px;
      height: 2px;
      background: rgba(255, 255, 255, 0.06);
      position: relative;
      overflow: hidden;
    }

    .loading-screen__progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: #f60434;
      transition: width 0.3s ease;
    }

    .loading-screen__detail {
      margin-top: 20px;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      letter-spacing: 1.5px;
      color: #333;
      text-transform: uppercase;
    }

    /* Subtle scanline on loading screen */
    .loading-screen::after {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(255, 255, 255, 0.01) 2px,
        rgba(255, 255, 255, 0.01) 4px
      );
      pointer-events: none;
    }

    /* ========================================
       HEADER
       ======================================== */
    .checkout-header {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding: 0 24px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .checkout-header__back {
      position: absolute;
      left: 24px;
      top: 50%;
      transform: translateY(-50%);
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #555;
      text-decoration: none;
      transition: color 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkout-header__back:hover {
      color: #fff;
    }

    .checkout-header__back-arrow {
      font-size: 14px;
      line-height: 1;
    }

    .checkout-header__logo {
      height: 44px;
      width: auto;
      display: block;
    }

    .checkout-header__secure {
      position: absolute;
      right: 24px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 6px;
      font-family: 'Space Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #444;
    }

    .checkout-header__lock {
      width: 11px;
      height: 11px;
      color: #f60434;
    }

    /* ========================================
       COUNTDOWN TIMER
       ======================================== */
    .checkout-timer {
      background: #0e0e0e;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .checkout-timer__label {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #555;
    }

    .checkout-timer__time {
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 2px;
      color: #fff;
      min-width: 56px;
    }

    .checkout-timer__bar {
      flex: 1;
      max-width: 120px;
      height: 2px;
      background: rgba(255, 255, 255, 0.06);
      position: relative;
      overflow: hidden;
    }

    .checkout-timer__fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: #f60434;
      transition: width 1s linear;
      transform-origin: left;
    }

    /* Urgent state: under 2 minutes */
    .checkout-timer--urgent .checkout-timer__time {
      color: #f60434;
    }

    .checkout-timer--urgent .checkout-timer__label {
      color: #f60434;
      animation: timerPulse 1s ease-in-out infinite;
    }

    @keyframes timerPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    /* Expired state */
    .checkout-timer--expired .checkout-timer__time {
      color: #f60434;
    }

    .checkout-timer--expired .checkout-timer__label {
      color: #f60434;
    }

    /* ========================================
       ORDER SUMMARY STRIP
       ======================================== */
    .checkout-summary {
      background: linear-gradient(180deg, rgba(20,20,20,0.98) 0%, rgba(15,15,15,0.95) 100%);
      border-bottom: 1px solid rgba(246, 4, 52, 0.2);
      padding: 14px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }

    .checkout-summary__label {
      font-family: 'Space Mono', monospace;
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 4px;
    }

    .checkout-summary__items {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .checkout-summary__item {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      letter-spacing: 0.5px;
      color: #aaa;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkout-summary__qty {
      background: rgba(246, 4, 52, 0.15);
      color: #fff;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
    }

    .checkout-summary__name {
      color: #ddd;
    }

    .checkout-summary__size {
      color: #f60434;
      font-weight: 600;
    }

    .checkout-summary__text {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: #888;
    }

    .checkout-summary__price {
      color: #f60434;
      font-weight: 700;
    }

    /* ========================================
       EMBED CONTAINER
       ======================================== */
    #eventix-shop-container {
      background: #1c1c1c;
      width: 100%;
      min-height: calc(100vh - 120px);
      overflow: visible;
    }

    #eventix-shop-container > div,
    #eventix-shop-container > div > div {
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
      padding: 0 !important;
    }

    #eventix-shop-container iframe {
      width: 100% !important;
      max-width: none !important;
      min-width: 100% !important;
      height: 2400px;
      min-height: 2400px;
      border: none !important;
      display: block;
      background: #1c1c1c;
    }


    /* ========================================
       RESPONSIVE
       ======================================== */
    @media (max-width: 600px) {
      .checkout-header {
        height: 64px;
        padding: 0 16px;
      }

      .checkout-header__back {
        left: 16px;
      }

      .checkout-header__logo {
        height: 34px;
      }

      .checkout-header__secure {
        right: 16px;
        font-size: 8px;
        letter-spacing: 1.5px;
        gap: 4px;
      }

      .checkout-header__lock {
        width: 10px;
        height: 10px;
      }

      .checkout-timer {
        padding: 10px 16px;
        gap: 8px;
      }

      .checkout-timer__label {
        font-size: 9px;
        letter-spacing: 1.5px;
      }

      .checkout-timer__time {
        font-size: 13px;
      }

      .checkout-summary {
        padding: 12px 16px;
        gap: 4px;
      }

      .checkout-summary__label {
        font-size: 8px;
        margin-bottom: 2px;
      }

      .checkout-summary__item {
        font-size: 10px;
      }

      .checkout-summary__qty {
        font-size: 9px;
        padding: 1px 5px;
      }

      .loading-screen__logo {
        width: 110px;
      }
    }
  </style>

  <!-- Cookie banner styles (inlined to avoid loading full site stylesheet) -->
  <style>
    .cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9998;
      background: rgba(14, 14, 14, 0.97);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding: 18px 24px;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .cookie-banner--visible { transform: translateY(0); }
    .cookie-banner__inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }
    .cookie-banner__message {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      line-height: 1.6;
      letter-spacing: 0.5px;
      color: #999;
    }
    .cookie-banner__actions {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }
    .cookie-banner__btn {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: none;
      cursor: pointer;
      padding: 10px 20px;
      transition: all 0.15s ease;
      white-space: nowrap;
    }
    .cookie-banner__btn--accept { background: #f60434; color: #fff; }
    .cookie-banner__btn--accept:hover { background: #ff1a4a; }
    .cookie-banner__btn--manage { background: transparent; color: #666; border: 1px solid #333; }
    .cookie-banner__btn--manage:hover { color: #fff; border-color: #555; }
    .cookie-panel {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      background: #111;
      border-top: 1px solid rgba(246, 4, 52, 0.2);
      padding: 0;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .cookie-panel--visible { max-height: 500px; }
    .cookie-panel__inner { padding: 24px; max-width: 600px; margin: 0 auto; }
    .cookie-panel__header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .cookie-panel__title { font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: #fff; }
    .cookie-panel__close { background: none; border: none; color: #555; font-size: 20px; cursor: pointer; padding: 4px 8px; line-height: 1; transition: color 0.15s; }
    .cookie-panel__close:hover { color: #fff; }
    .cookie-panel__categories { display: flex; flex-direction: column; gap: 14px; margin-bottom: 20px; }
    .cookie-panel__category { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.04); }
    .cookie-panel__category-name { font-family: 'Space Mono', monospace; font-size: 11px; letter-spacing: 1.5px; text-transform: uppercase; color: #ccc; display: block; margin-bottom: 2px; }
    .cookie-panel__category-desc { font-family: 'Space Mono', monospace; font-size: 9px; color: #555; letter-spacing: 0.3px; }
    .cookie-panel__toggle { position: relative; width: 40px; height: 22px; flex-shrink: 0; }
    .cookie-panel__toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
    .cookie-panel__slider { position: absolute; inset: 0; background: #333; border-radius: 22px; cursor: pointer; transition: background 0.2s; }
    .cookie-panel__slider::before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: #888; border-radius: 50%; transition: transform 0.2s, background 0.2s; }
    .cookie-panel__toggle input:checked + .cookie-panel__slider { background: #f60434; }
    .cookie-panel__toggle input:checked + .cookie-panel__slider::before { transform: translateX(18px); background: #fff; }
    .cookie-panel__slider--locked { opacity: 0.5; cursor: not-allowed; }
    .cookie-panel__slider--locked::before { background: #fff; }
    .cookie-panel__toggle--locked .cookie-panel__slider { background: #444; }
    .cookie-panel__actions { display: flex; gap: 10px; }

    @media (max-width: 600px) {
      .cookie-banner { padding: 14px 16px; }
      .cookie-banner__inner { flex-direction: column; gap: 14px; text-align: center; }
      .cookie-banner__message { font-size: 10px; }
      .cookie-banner__actions { width: 100%; justify-content: center; }
      .cookie-banner__btn { padding: 10px 16px; font-size: 9px; flex: 1; }
      .cookie-panel__inner { padding: 18px 16px; }
      .cookie-panel__actions { flex-direction: column; }
      .cookie-panel__actions .cookie-banner__btn { width: 100%; text-align: center; }
    }
  </style>

  <!-- Cookie Consent -->
  <script src="../../../js/cookie-consent.js"></script>
</head>
<body>

  <!-- Loading Interstitial -->
  <div class="loading-screen" id="loadingScreen">
    <img src="../../../images/FERAL%20LOGO.svg" alt="FERAL PRESENTS" class="loading-screen__logo">
    <div class="loading-screen__status" id="loadingStatus">Preparing your tickets</div>
    <div class="loading-screen__bar">
      <div class="loading-screen__progress" id="loadingProgress"></div>
    </div>
    <div class="loading-screen__detail" id="loadingDetail">Connecting to checkout&hellip;</div>
  </div>

  <!-- Header -->
  <div class="checkout-header">
    <a href="/event/liverpool-27-march/" class="checkout-header__back">
      <span class="checkout-header__back-arrow">&larr;</span>
      <span>Back</span>
    </a>
    <a href="/event/liverpool-27-march/">
      <img src="../../../images/FERAL%20LOGO.svg" alt="FERAL PRESENTS" class="checkout-header__logo">
    </a>
    <div class="checkout-header__secure">
      <svg class="checkout-header__lock" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="5" y="11" width="14" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
        <path d="M8 11V7a4 4 0 018 0v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      <span>Secure Checkout</span>
    </div>
  </div>

  <!-- Countdown Timer -->
  <div class="checkout-timer" id="checkoutTimer">
    <span class="checkout-timer__label">Reservation expires</span>
    <span class="checkout-timer__time" id="timerDisplay">08:02</span>
    <div class="checkout-timer__bar">
      <div class="checkout-timer__fill" id="timerBar"></div>
    </div>
  </div>

  <!-- Order Summary Strip -->
  <div class="checkout-summary" id="checkoutSummary">
    <div class="checkout-summary__label">Your Order</div>
    <div class="checkout-summary__items" id="summaryItems">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- Embed -->
  <div id="eventix-shop-container"></div>


  <script src="https://v1.widget.shop.eventix.io/injector.js"></script>
  <script>
    (async function() {
      var SHOP_ID = 'ad7b1eab-9c0b-4525-be60-be9c1c523dfe';
      var TIMER_SECONDS = (8 * 60) + 2; // 8 minutes 2 seconds (offset for embed timer)

      // Default ticket definitions
      var TICKET_INFO = {
        '6b45169f-cf51-4600-8682-d6f79dcb59ae': { name: 'General Release', price: 26.46 },
        '53c5262b-93ba-412e-bb5c-84ebc445a734': { name: 'VIP Black + Limited Edition Tee', price: 65.00 },
        'bb73bb64-ba1a-4a23-9a05-f2b57bca51cf': { name: 'VIP Ticket', price: 35.00 }
      };

      // Load settings from admin panel (includes size-specific IDs)
      (function() {
        try {
          var stored = localStorage.getItem('feral_event_liverpool');
          if (stored) {
            var settings = JSON.parse(stored);

            // Update ticket IDs if configured
            if (settings.ticketId1) {
              var oldId1 = '6b45169f-cf51-4600-8682-d6f79dcb59ae';
              if (settings.ticketId1 !== oldId1) {
                TICKET_INFO[settings.ticketId1] = TICKET_INFO[oldId1];
                delete TICKET_INFO[oldId1];
              }
              if (settings.ticketName1) TICKET_INFO[settings.ticketId1].name = settings.ticketName1;
            }

            if (settings.ticketId2) {
              var oldId2 = 'bb73bb64-ba1a-4a23-9a05-f2b57bca51cf';
              if (settings.ticketId2 !== oldId2) {
                TICKET_INFO[settings.ticketId2] = TICKET_INFO[oldId2];
                delete TICKET_INFO[oldId2];
              }
              if (settings.ticketName2) TICKET_INFO[settings.ticketId2].name = settings.ticketName2;
            }

            if (settings.ticketId3) {
              var oldId3 = '53c5262b-93ba-412e-bb5c-84ebc445a734';
              var mainTeeId = settings.ticketId3;
              if (mainTeeId !== oldId3) {
                TICKET_INFO[mainTeeId] = TICKET_INFO[oldId3];
                delete TICKET_INFO[oldId3];
              }
              if (settings.ticketName3) TICKET_INFO[mainTeeId].name = settings.ticketName3;
            }

            // Add size-specific IDs with size suffix in name
            var mainTeeName = settings.ticketName3 || 'VIP Black + Limited Edition Tee';
            var teePrice = 65.00;
            var sizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL'];
            var sizeKeys = ['sizeIdXS', 'sizeIdS', 'sizeIdM', 'sizeIdL', 'sizeIdXL', 'sizeIdXXL'];

            sizes.forEach(function(size, i) {
              var sizeId = settings[sizeKeys[i]];
              if (sizeId && !TICKET_INFO[sizeId]) {
                TICKET_INFO[sizeId] = {
                  name: mainTeeName + ' (' + size + ')',
                  price: teePrice
                };
              }
            });
          }
        } catch (e) {
          console.error('Failed to load settings:', e);
        }
      })();

      // Parse cart from URL
      // Format: cart=ticketId:qty,ticketId:qty OR legacy: qty=N (single general release)
      var params = new URLSearchParams(window.location.search);
      var cartItems = []; // Array of { id, qty, name, price }

      var cartParam = params.get('cart');
      if (cartParam) {
        // New format: cart=id1:qty1,id2:qty2
        var items = cartParam.split(',');
        items.forEach(function(item) {
          var parts = item.split(':');
          if (parts.length === 2) {
            var ticketId = parts[0];
            var ticketQty = parseInt(parts[1], 10) || 0;
            if (ticketQty > 0 && TICKET_INFO[ticketId]) {
              cartItems.push({
                id: ticketId,
                qty: ticketQty,
                name: TICKET_INFO[ticketId].name,
                price: TICKET_INFO[ticketId].price
              });
            }
          }
        });
      } else {
        // Legacy format: qty=N (general release only)
        var legacyQty = parseInt(params.get('qty'), 10) || 1;
        var generalId = '6b45169f-cf51-4600-8682-d6f79dcb59ae';
        cartItems.push({
          id: generalId,
          qty: legacyQty,
          name: TICKET_INFO[generalId].name,
          price: TICKET_INFO[generalId].price
        });
      }

      // Calculate totals
      var totalQty = cartItems.reduce(function(sum, item) { return sum + item.qty; }, 0);
      var totalPrice = cartItems.reduce(function(sum, item) { return sum + (item.qty * item.price); }, 0);

      // --- Update order summary ---
      var summaryItems = document.getElementById('summaryItems');
      if (summaryItems && cartItems.length > 0) {
        var itemsHtml = cartItems.map(function(item) {
          return '<div class="checkout-summary__item">' +
            '<span class="checkout-summary__qty">' + item.qty + '</span>' +
            '<span class="checkout-summary__name">' + item.name + '</span>' +
            '</div>';
        });
        summaryItems.innerHTML = itemsHtml.join('');
      }

      // --- Loading screen ---
      var loadingScreen = document.getElementById('loadingScreen');
      var loadingProgress = document.getElementById('loadingProgress');
      var loadingStatus = document.getElementById('loadingStatus');
      var loadingDetail = document.getElementById('loadingDetail');

      function setLoadingProgress(pct, detail) {
        if (loadingProgress) loadingProgress.style.width = pct + '%';
        if (detail && loadingDetail) loadingDetail.textContent = detail;
      }

      function hideLoadingScreen() {
        if (loadingScreen) loadingScreen.classList.add('loading-screen--hidden');
        // Start countdown timer when checkout becomes visible
        startTimer();
      }

      setLoadingProgress(10, 'Connecting to checkout\u2026');

      // --- 8-minute countdown timer ---
      var timerDisplay = document.getElementById('timerDisplay');
      var timerBar = document.getElementById('timerBar');
      var checkoutTimer = document.getElementById('checkoutTimer');
      var timerStarted = false;
      var timerRemaining = TIMER_SECONDS;

      function formatTime(s) {
        var m = Math.floor(s / 60);
        var sec = s % 60;
        return (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
      }

      function startTimer() {
        if (timerStarted) return;
        timerStarted = true;

        var interval = setInterval(function() {
          timerRemaining--;

          if (timerRemaining <= 0) {
            timerRemaining = 0;
            clearInterval(interval);
            if (timerDisplay) timerDisplay.textContent = '00:00';
            if (timerBar) timerBar.style.width = '0%';
            if (checkoutTimer) checkoutTimer.classList.add('checkout-timer--expired');
            return;
          }

          if (timerDisplay) timerDisplay.textContent = formatTime(timerRemaining);
          if (timerBar) timerBar.style.width = ((timerRemaining / TIMER_SECONDS) * 100) + '%';

          // Urgent at 2 minutes
          if (timerRemaining <= 120 && checkoutTimer) {
            checkoutTimer.classList.add('checkout-timer--urgent');
          }
        }, 1000);
      }

      // --- WeeZTix ShopInjector ---
      function getCookie(name) {
        var nameEQ = name + '=';
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0) === ' ') c = c.substring(1, c.length);
          if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
      }

      function getPersistedValues() {
        var sessionValue = window.sessionStorage.getItem('@openticket:persist-campaign-data:entries');
        if (sessionValue) return JSON.parse(sessionValue);
        var cookieValue = getCookie('@openticket:persist-campaign-data:entries');
        if (cookieValue) return JSON.parse(cookieValue);
        return {};
      }

      function waitForOpenTicket() {
        return new Promise(function(resolve) {
          function check() {
            if (window.OpenTicket && window.OpenTicket.ShopInjector) {
              resolve();
            } else {
              setTimeout(check, 200);
            }
          }
          check();
        });
      }

      setLoadingProgress(25, 'Loading payment system\u2026');
      await waitForOpenTicket();
      setLoadingProgress(40, 'Initialising shop\u2026');

      var config = {
        url: 'https://shop.weeztix.com/' + SHOP_ID,
        guid: SHOP_ID,
        container: 'eventix-shop-container',
        cookiePreferences: {
          functional: true,
          analytical: true,
          organiserMarketing: true,
          embeddedContent: true
        }
      };

      var persistedValues = getPersistedValues();
      if (Object.keys(persistedValues).length !== 0) {
        config.trackingInfo = persistedValues;
      }

      window.ShopInjector = new window.OpenTicket.ShopInjector();
      await window.ShopInjector.init(config);

      setLoadingProgress(60, 'Adding ' + totalQty + (totalQty === 1 ? ' ticket' : ' tickets') + ' to cart\u2026');
      if (loadingStatus) loadingStatus.textContent = 'Securing your tickets';

      // Resize iframe — use content height from embed if available, otherwise stay large
      var container = document.getElementById('eventix-shop-container');
      var observer = new MutationObserver(function() {
        var iframe = container.querySelector('iframe');
        if (iframe) {
          // Listen for the embed reporting its actual content height
          window.addEventListener('message', function(e) {
            if (e.data && typeof e.data.height === 'number') {
              // Use reported height but never shrink below 2400px
              var h = Math.max(2400, e.data.height + 100);
              iframe.style.height = h + 'px';
              iframe.style.minHeight = h + 'px';
            }
          });

          observer.disconnect();
        }
      });
      observer.observe(container, { childList: true, subtree: true });

      // Build a queue of tickets to add: [{ id, remaining }, ...]
      var ticketQueue = cartItems.map(function(item) {
        return { id: item.id, remaining: item.qty, added: 0 };
      });
      var currentTicketIndex = 0;
      var totalTicketsAdded = 0;

      function getCurrentTicket() {
        while (currentTicketIndex < ticketQueue.length && ticketQueue[currentTicketIndex].remaining <= 0) {
          currentTicketIndex++;
        }
        return ticketQueue[currentTicketIndex] || null;
      }

      function addNextTicket() {
        var ticket = getCurrentTicket();
        if (!ticket) return;

        window.ShopInjector.shop.sendMessage({
          action: 'add',
          guid: ticket.id,
          type: 'ticket'
        });
      }

      window.ShopInjector.shop.onCartData(function(data) {
        if (totalTicketsAdded >= totalQty) return;

        // Count total tickets in cart across all our ticket types
        var cartTotal = 0;
        ticketQueue.forEach(function(ticket) {
          if (data && data.tickets && data.tickets[ticket.id]) {
            var count = data.tickets[ticket.id].count || 0;
            ticket.added = count;
            cartTotal += count;
          }
        });

        if (cartTotal > totalTicketsAdded) {
          totalTicketsAdded = cartTotal;

          // Update remaining counts
          ticketQueue.forEach(function(ticket) {
            var targetQty = cartItems.find(function(c) { return c.id === ticket.id; }).qty;
            ticket.remaining = targetQty - ticket.added;
          });

          // Update loading progress
          var pct = 60 + Math.round((totalTicketsAdded / totalQty) * 35);
          setLoadingProgress(pct, 'Added ' + totalTicketsAdded + ' of ' + totalQty + (totalQty === 1 ? ' ticket' : ' tickets'));

          if (totalTicketsAdded >= totalQty) {
            // All tickets added — show checkout
            setLoadingProgress(100, 'Ready');
            if (loadingStatus) loadingStatus.textContent = 'All set';
            setTimeout(hideLoadingScreen, 400);
          } else {
            setTimeout(addNextTicket, 150);
          }
        }
      });

      // Also hide loading if embed loads before tickets are confirmed
      var embedReady = false;
      window.ShopInjector.shop.onCartData(function() {
        if (!embedReady) {
          embedReady = true;
          // If totalQty is 0 or loading is taking too long, hide after a timeout
        }
      });

      // Fallback: hide loading screen after 12s no matter what
      setTimeout(function() {
        if (!loadingScreen.classList.contains('loading-screen--hidden')) {
          setLoadingProgress(100, 'Ready');
          setTimeout(hideLoadingScreen, 300);
        }
      }, 12000);

      // Start adding tickets
      setTimeout(function() {
        addNextTicket();
      }, 500);
    })();
  </script>

  <!-- ============================================
       DISCOUNT POPUP — Checkout Fallback
       Shows if user reached checkout without seeing popup on event page
       ============================================ -->
  <style>
    /* Overlay */
    .dp-overlay {
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.45s ease, visibility 0.45s ease;
    }
    .dp-overlay--visible {
      opacity: 1;
      visibility: visible;
    }

    /* Modal */
    .dp-modal {
      background: #111;
      border: 1px solid rgba(255, 255, 255, 0.08);
      width: 100%;
      max-width: 400px;
      position: relative;
      overflow: hidden;
      transform: translateY(18px) scale(0.97);
      opacity: 0;
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.4s ease;
    }
    .dp-overlay--visible .dp-modal {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    /* Close */
    .dp-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: none;
      border: none;
      color: #444;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      z-index: 10;
      padding: 4px;
      transition: color 0.15s ease;
    }
    .dp-close:hover { color: #fff; }

    /* Screen container */
    .dp-screen { display: none; }
    .dp-screen--active { display: block; }

    /* Body */
    .dp-body {
      padding: 32px 28px 28px;
      text-align: center;
    }

    /* Logo */
    .dp-logo {
      width: 80px;
      height: auto;
      margin-bottom: 20px;
      opacity: 0.9;
    }

    /* Headlines */
    .dp-headline {
      font-family: 'Space Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      line-height: 1.3;
      margin-bottom: 8px;
      color: #fff;
    }

    .dp-sub {
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      color: #888;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* Buttons */
    .dp-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 0;
    }

    .dp-btn {
      flex: 1;
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      padding: 14px 16px;
      border: none;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .dp-btn--primary {
      background: #ff0033;
      color: #fff;
    }
    .dp-btn--primary:hover { background: #e6002e; }

    .dp-btn--secondary {
      background: transparent;
      color: rgba(255, 255, 255, 0.5);
      border: 1px solid #333;
    }
    .dp-btn--secondary:hover { color: rgba(255, 255, 255, 0.7); border-color: #555; }

    /* Email input */
    .dp-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: #fff;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      padding: 13px 16px;
      margin-bottom: 12px;
      outline: none;
      transition: border-color 0.15s ease;
      text-align: center;
    }
    .dp-input::placeholder { color: #444; }
    .dp-input:focus { border-color: rgba(255, 0, 51, 0.5); }

    .dp-error {
      color: #ff0033;
      font-size: 11px;
      margin-bottom: 10px;
      display: none;
    }
    .dp-error--visible { display: block; }

    /* Timer */
    .dp-timer {
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      padding: 14px 28px;
      background: rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .dp-timer__label {
      font-family: 'Inter', sans-serif;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      color: #555;
      margin-bottom: 4px;
    }

    .dp-timer__time {
      font-family: 'Space Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      color: #ff0033;
      letter-spacing: 3px;
    }

    /* Discount code display */
    .dp-code {
      background: rgba(255, 0, 51, 0.08);
      border: 1px dashed rgba(255, 0, 51, 0.3);
      padding: 14px 20px;
      margin: 16px 0;
      display: inline-block;
    }

    .dp-code__value {
      font-family: 'Space Mono', monospace;
      font-size: 22px;
      font-weight: 700;
      letter-spacing: 4px;
      color: #ff0033;
    }

    .dp-note {
      font-family: 'Inter', sans-serif;
      font-size: 12px;
      color: #666;
      line-height: 1.5;
      margin-top: 8px;
    }

    /* Urgency timer on screen 3 */
    .dp-urgency {
      background: rgba(255, 0, 51, 0.06);
      border: 1px solid rgba(255, 0, 51, 0.15);
      padding: 12px 16px;
      margin: 16px 0 8px;
      text-align: center;
    }
    .dp-urgency__label {
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: rgba(255, 255, 255, 0.5);
      margin-bottom: 4px;
    }
    .dp-urgency__countdown {
      font-family: 'Space Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      color: #ff0033;
      letter-spacing: 2px;
    }

    .dp-done-btn {
      width: 100%;
      margin-top: 20px;
    }
  </style>

  <div class="dp-overlay" id="dpOverlay">
    <div class="dp-modal">
      <button class="dp-close" id="dpClose">&times;</button>

      <!-- Screen 1: Micro-commitment -->
      <div class="dp-screen dp-screen--active" id="dpScreen1">
        <div class="dp-body">
          <img src="../../../images/FERAL%20LOGO.svg" alt="FERAL" class="dp-logo">
          <h2 class="dp-headline">Wait — Before You Pay</h2>
          <p class="dp-sub">Want 10% off your tickets? Grab it now before checkout.</p>
          <div class="dp-buttons">
            <button class="dp-btn dp-btn--primary" id="dpYes">Get 10% Off</button>
            <button class="dp-btn dp-btn--secondary" id="dpNo">No Thanks</button>
          </div>
        </div>
        <div class="dp-timer">
          <span class="dp-timer__label">Offer expires</span>
          <span class="dp-timer__time" id="dpTimer">04:59</span>
        </div>
      </div>

      <!-- Screen 2: Email capture -->
      <div class="dp-screen" id="dpScreen2">
        <div class="dp-body">
          <img src="../../../images/FERAL%20LOGO.svg" alt="FERAL" class="dp-logo">
          <h2 class="dp-headline">Unlock 10% Off</h2>
          <p class="dp-sub">Enter your email to reveal your discount code.</p>
          <form id="dpForm">
            <input type="email" class="dp-input" id="dpEmail" placeholder="Your email address" required>
            <div class="dp-error" id="dpError">Please enter a valid email</div>
            <button type="submit" class="dp-btn dp-btn--primary" style="width: 100%;">Get My Discount</button>
          </form>
        </div>
        <div class="dp-timer">
          <span class="dp-timer__label">Offer expires</span>
          <span class="dp-timer__time" id="dpTimer2">04:59</span>
        </div>
      </div>

      <!-- Screen 3: Discount code reveal -->
      <div class="dp-screen" id="dpScreen3">
        <div class="dp-body">
          <img src="../../../images/FERAL%20LOGO.svg" alt="FERAL" class="dp-logo">
          <h2 class="dp-headline">You're In</h2>
          <p class="dp-sub">Here's your discount code. Enter it below at checkout.</p>
          <div class="dp-code">
            <span class="dp-code__value">FERALRAVER10</span>
          </div>
          <div class="dp-urgency">
            <div class="dp-urgency__label">Code expires in</div>
            <div class="dp-urgency__countdown" id="dpCodeExpiry">24:00:00</div>
          </div>
          <p class="dp-note">This code won't be shown again. Use it now before it expires.</p>
          <button class="dp-btn dp-btn--primary dp-done-btn" id="dpDone">Continue to Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase for persistent analytics -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    (function() {
      var KLAVIYO_LIST_ID = 'SnE86f';
      var POPUP_KEY = 'feral_dp_shown';
      var TIMER_TOTAL = 299; // 4:59
      var STATS_KEY = 'feral_popup_stats';

      // Supabase configuration
      var SUPABASE_URL = 'https://rqtfghzhkkdytkegcifm.supabase.co';
      var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxdGZnaHpoa2tkeXRrZWdjaWZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMTUwMTUsImV4cCI6MjA4NTY5MTAxNX0.8IVDc92EYAq4FhTqVy0k5ur79zD9XofBBFjAuctKOUc';
      var supabaseClient = null;

      // Initialize Supabase
      if (window.supabase && window.supabase.createClient) {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('[FERAL Popup] Supabase connected for analytics (checkout)');
      }

      // Analytics tracking — sends to Supabase + localStorage fallback
      function trackPopup(action) {
        // Local storage fallback for immediate feedback
        var stats = JSON.parse(localStorage.getItem(STATS_KEY) || '{}');
        stats[action] = (stats[action] || 0) + 1;
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
        console.log('[FERAL Popup] Tracked:', action, '| Stats:', JSON.stringify(stats));

        // Send to Supabase for persistent storage
        if (supabaseClient) {
          supabaseClient.from('popup_events').insert({
            event_type: action,
            page: 'liverpool-checkout',
            timestamp: new Date().toISOString(),
            user_agent: navigator.userAgent.substring(0, 500)
          }).then(function(res) {
            if (res.error) {
              console.log('[FERAL Popup] Supabase error:', res.error.message);
            } else {
              console.log('[FERAL Popup] Saved to Supabase:', action);
            }
          });
        }
      }

      // Don't show if already dismissed/completed within last 30 days
      var lastShown = localStorage.getItem(POPUP_KEY);
      if (lastShown && (Date.now() - parseInt(lastShown, 10)) < 30 * 24 * 60 * 60 * 1000) return;

      var overlay = document.getElementById('dpOverlay');
      var screen1 = document.getElementById('dpScreen1');
      var screen2 = document.getElementById('dpScreen2');
      var screen3 = document.getElementById('dpScreen3');
      var timerEl1 = document.getElementById('dpTimer');
      var timerEl2 = document.getElementById('dpTimer2');
      var remaining = TIMER_TOTAL;
      var timerInterval = null;

      function formatTime(s) {
        var m = Math.floor(s / 60);
        var sec = s % 60;
        return (m < 10 ? '0' : '') + m + ':' + (sec < 10 ? '0' : '') + sec;
      }

      function startTimer() {
        timerInterval = setInterval(function() {
          remaining--;
          if (remaining <= 0) {
            remaining = 0;
            clearInterval(timerInterval);
          }
          var t = formatTime(remaining);
          timerEl1.textContent = t;
          timerEl2.textContent = t;
        }, 1000);
      }

      function showPopup() {
        overlay.classList.add('dp-overlay--visible');
        document.body.style.overflow = 'hidden';
        startTimer();
        trackPopup('impressions');
      }

      function hidePopup() {
        overlay.classList.remove('dp-overlay--visible');
        document.body.style.overflow = '';
        clearInterval(timerInterval);
        localStorage.setItem(POPUP_KEY, Date.now().toString());
      }

      function goToScreen(screen) {
        screen1.classList.remove('dp-screen--active');
        screen2.classList.remove('dp-screen--active');
        screen3.classList.remove('dp-screen--active');
        screen.classList.add('dp-screen--active');
      }

      // Checkout fallback: show popup after 6 seconds
      // This catches users who navigated to checkout without seeing the popup
      setTimeout(showPopup, 6000);

      // Close button
      document.getElementById('dpClose').addEventListener('click', function() {
        trackPopup('closed');
        hidePopup();
      });

      // Click overlay to close
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) hidePopup();
      });

      // Escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') hidePopup();
      });

      // Screen 1: "Get 10% Off"
      document.getElementById('dpYes').addEventListener('click', function() {
        goToScreen(screen2);
        trackPopup('engaged');
        setTimeout(function() {
          document.getElementById('dpEmail').focus();
        }, 100);
      });

      // Screen 1: "No Thanks"
      document.getElementById('dpNo').addEventListener('click', function() {
        trackPopup('dismissed');
        hidePopup();
      });

      // Screen 2: Email form submit
      document.getElementById('dpForm').addEventListener('submit', function(e) {
        e.preventDefault();
        var email = document.getElementById('dpEmail').value.trim();
        var errorEl = document.getElementById('dpError');

        if (!email || email.indexOf('@') === -1 || email.indexOf('.') === -1) {
          errorEl.classList.add('dp-error--visible');
          return;
        }
        errorEl.classList.remove('dp-error--visible');

        // Subscribe to Klaviyo
        var formData = new FormData();
        formData.append('g', KLAVIYO_LIST_ID);
        formData.append('email', email);
        fetch('https://manage.kmail-lists.com/ajax/subscriptions/subscribe', {
          method: 'POST',
          body: formData
        }).catch(function() {});

        // Identify in Klaviyo if SDK loaded
        if (window._learnq) {
          window._learnq.push(['identify', { '$email': email }]);
          window._learnq.push(['track', 'Discount Popup Signup', {
            'Event': 'FERAL Liverpool — 27 March 2026',
            'Source': 'Checkout Popup',
            'Code': 'FERALRAVER10'
          }]);
        }

        // Show code screen and start 24h countdown
        goToScreen(screen3);
        clearInterval(timerInterval);
        localStorage.setItem(POPUP_KEY, Date.now().toString());
        trackPopup('conversions');
        startCodeExpiry();
      });

      // 24-hour code expiry countdown
      var CODE_EXPIRY_KEY = 'feral_code_expiry';
      var expiryInterval = null;

      function startCodeExpiry() {
        var expiryEl = document.getElementById('dpCodeExpiry');
        // Set expiry to 24 hours from now (or use existing)
        var expiry = localStorage.getItem(CODE_EXPIRY_KEY);
        if (!expiry) {
          expiry = Date.now() + (24 * 60 * 60 * 1000);
          localStorage.setItem(CODE_EXPIRY_KEY, expiry.toString());
        } else {
          expiry = parseInt(expiry, 10);
        }

        function updateExpiry() {
          var remaining = Math.max(0, expiry - Date.now());
          var hours = Math.floor(remaining / (1000 * 60 * 60));
          var minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
          var seconds = Math.floor((remaining % (1000 * 60)) / 1000);
          expiryEl.textContent =
            (hours < 10 ? '0' : '') + hours + ':' +
            (minutes < 10 ? '0' : '') + minutes + ':' +
            (seconds < 10 ? '0' : '') + seconds;
          if (remaining <= 0) {
            expiryEl.textContent = 'EXPIRED';
            clearInterval(expiryInterval);
          }
        }
        updateExpiry();
        expiryInterval = setInterval(updateExpiry, 1000);
      }

      // Screen 3: "Continue to Checkout" — just close popup
      document.getElementById('dpDone').addEventListener('click', function() {
        hidePopup();
      });
    })();
  </script>

  <!-- Supabase for traffic analytics -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- FERAL Traffic Analytics -->
  <script src="../../../js/feral-traffic.js"></script>
</body>
</html>
